<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Î— ÎœÎµÎ³Î¬Î»Î· Î¤Î¹Î¼Ï‰ÏÎ¯Î± ğŸ“œ</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #1a1a1a;
            --accent-red: #ff3333;
            --text-color: #f0f0f0;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            margin: 0; padding: 0; height: 100vh; overflow: hidden;
            background: var(--bg-color); color: var(--text-color);
            display: flex; flex-direction: column; user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        h1 {
            text-align: center; margin: 15px 0; z-index: 10; font-size: 1.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            position: absolute; width: 100%; top: 0; pointer-events: none;
        }

        /* DRAG GAME STYLES */
        .container { display: flex; width: 100%; height: 100%; }
        .zone {
            width: 50%; height: 100%; display: flex; flex-direction: column;
            justify-content: center; align-items: center; transition: opacity 0.3s;
        }
        .naughty { background: linear-gradient(135deg, #8b0000, #500000); border-right: 1px solid #ffffff33; }
        .nice { background: linear-gradient(135deg, #006400, #004d00); }
        .icon { font-size: 3rem; opacity: 0.6; margin-bottom: 10px; }
        .zone-title { font-size: 1.2rem; font-weight: 900; opacity: 0.8; letter-spacing: 2px; }

        #draggable-name {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; color: #333; padding: 15px 30px; border-radius: 50px;
            font-size: 1.2rem; font-weight: 800; box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            cursor: grab; z-index: 100; touch-action: none; border: 4px solid #d4af37;
        }

        /* MODALS - Responsive & Scrollable */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 200;
            justify-content: center; align-items: center; padding: 20px; box-sizing: border-box;
        }

        .modal-content {
            background: #222; color: white; text-align: center; padding: 25px;
            border-radius: 20px; width: 100%; max-width: 400px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8); border: 1px solid #444;
            max-height: 85vh; overflow-y: auto; position: relative;
        }

        h2 { color: var(--accent-red); margin-top: 0; font-size: 1.5rem; }
        p { line-height: 1.6; color: #ccc; font-size: 0.95rem; margin-bottom: 20px; }

        /* BUTTONS */
        .btn {
            background: white; color: black; border: none; padding: 15px 30px;
            font-size: 1rem; font-weight: bold; border-radius: 50px; cursor: pointer;
            width: 100%; margin-top: 10px; transition: transform 0.1s;
            box-shadow: 0 5px 15px rgba(255,255,255,0.1);
        }
        .btn:active { transform: scale(0.95); }
        .btn-red { background: var(--accent-red); color: white; }
        .btn-green { background: #009246; color: white; }

        /* INPUTS */
        input[type="file"] { margin: 20px 0; color: white; }
        .quiz-btn { background: #333; color: white; border: 1px solid #555; text-align: left; }
        
        /* THE CORNER (TIMEOUT) STYLES */
        #cornerUI {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: black; z-index: 500; flex-direction: column;
            justify-content: center; align-items: center; color: white;
        }
        #timerDisplay { font-size: 5rem; font-weight: 900; font-family: monospace; color: var(--accent-red); }
        .corner-msg { font-size: 1.2rem; color: #666; margin-top: 20px; text-align: center; padding: 0 20px;}
        .keep-awake-btn {
            margin-top: 50px; padding: 20px; border-radius: 50%; width: 100px; height: 100px;
            background: #333; border: 2px solid #555; color: #888; font-size: 0.8rem;
        }

        /* LOADING BAR */
        .progress-container { width: 100%; height: 10px; background: #444; border-radius: 5px; margin-top: 15px; overflow: hidden; }
        .progress-bar { width: 0%; height: 100%; background: var(--accent-red); transition: width 0.3s; }

    </style>
</head>
<body>

    <h1>ÎšÎ¡Î™Î£Î— & Î¤Î™ÎœÎ©Î¡Î™Î‘ âš–ï¸</h1>

    <div class="container" id="dragGame">
        <div class="zone naughty" id="zone-naughty">
            <div class="icon">ğŸ˜ˆ</div>
            <div class="zone-title">NAUGHTY</div>
        </div>
        <div class="zone nice" id="zone-nice">
            <div class="icon">ğŸ˜‡</div>
            <div class="zone-title">NICE</div>
        </div>
    </div>

    <div id="draggable-name">Î£Î‘Î¡Î‘</div>

    <div id="punishIntroModal" class="modal">
        <div class="modal-content">
            <div style="font-size: 4rem;">ğŸš¨</div>
            <h2>Î•Î§Î•Î™Î£ ÎšÎ¡Î™Î˜Î•Î™ Î•ÎÎŸÎ§Î—!</h2>
            <p>Î¤Î¿ ÏƒÏÏƒÏ„Î·Î¼Î± ÎµÎ½Ï„ÏŒÏ€Î¹ÏƒÎµ Ï€Î¿Î»Î»Î±Ï€Î»Î­Ï‚ Ï€Î±ÏÎ±Î²Î¬ÏƒÎµÎ¹Ï‚. Î”ÎµÎ½ Î¼Ï€Î¿ÏÎµÎ¯Ï‚ Î½Î± ÏƒÏ…Î½ÎµÏ‡Î¯ÏƒÎµÎ¹Ï‚ Ï„Î¿ Ï„Î±Î¾Î¯Î´Î¹ Î±Î½ Î´ÎµÎ½ ÎµÎºÏ„Î¯ÏƒÎµÎ¹Ï‚ Ï„Î·Î½ Ï€Î¿Î¹Î½Î® ÏƒÎ¿Ï….</p>
            <p>Î— Ï„Î¹Î¼Ï‰ÏÎ¯Î± Î±Ï€Î¿Ï„ÎµÎ»ÎµÎ¯Ï„Î±Î¹ Î±Ï€ÏŒ <strong>4 Î£Ï„Î¬Î´Î¹Î±</strong>.</p>
            <button class="btn btn-red" onclick="startPunishment()">Î‘Ï€Î¿Î´Î¿Ï‡Î® Î¤Î¹Î¼Ï‰ÏÎ¯Î±Ï‚</button>
        </div>
    </div>

    <div id="stage1Modal" class="modal">
        <div class="modal-content">
            <h2>Î£Î¤Î‘Î”Î™ÎŸ 1: Î‘ÎÎ‘ÎšÎ¡Î™Î£Î—</h2>
            <p>Î‘Ï€Î¬Î½Ï„Î·ÏƒÎµ ÏƒÏ‰ÏƒÏ„Î¬ Î³Î¹Î± Î½Î± ÏƒÏ…Î½ÎµÏ‡Î¯ÏƒÎµÎ¹Ï‚.</p>
            <div id="quizQuestion" style="font-weight:bold; font-size:1.1rem; margin-bottom:15px; color:#fff;"></div>
            <div id="quizOptions"></div>
            <div style="margin-top:10px; font-size:0.8rem; color:#666;">Î•ÏÏÏ„Î·ÏƒÎ· <span id="qNum">1</span>/5</div>
        </div>
    </div>

    <div id="stage2Modal" class="modal">
        <div class="modal-content">
            <h2>Î£Î¤Î‘Î”Î™ÎŸ 2: Î“Î¡Î‘Î¦Î—</h2>
            <p>Î Î¬ÏÎµ Ï‡Î±ÏÏ„Î¯ ÎºÎ±Î¹ ÏƒÏ„Ï…Î»ÏŒ. Î“ÏÎ¬ÏˆÎµ <strong>10 Ï†Î¿ÏÎ­Ï‚</strong> Ï„Î·Î½ Ï€Î±ÏÎ±ÎºÎ¬Ï„Ï‰ Ï†ÏÎ¬ÏƒÎ· ÏƒÏ„Î± Î™Ï„Î±Î»Î¹ÎºÎ¬:</p>
            <div style="background:#333; padding:10px; border-radius:10px; margin:10px 0; color:#00ff00; font-family:monospace;">
                "SarÃ² una brava ragazza quest'anno"
            </div>
            <p>Î’Î³Î¬Î»Îµ Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î± Ï„Î¿ Ï‡Î±ÏÏ„Î¯ ÎºÎ±Î¹ Î±Î½Î­Î²Î±ÏƒÎ­ Ï„Î·Î½ ÎµÎ´Ï Î³Î¹Î± Î­Î»ÎµÎ³Ï‡Î¿.</p>
            <input type="file" id="photoInput" accept="image/*">
            <button class="btn btn-red" id="uploadPhotoBtn" onclick="uploadPhoto()">Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î® Î‘Ï€Î¿Î´ÎµÎ¹ÎºÏ„Î¹ÎºÎ¿Ï</button>
            <div id="photoStatus" style="margin-top:10px; font-size:0.9rem;"></div>
        </div>
    </div>

    <div id="stage3Modal" class="modal">
        <div class="modal-content">
            <h2>Î£Î¤Î‘Î”Î™ÎŸ 3: ÎŸÎœÎŸÎ›ÎŸÎ“Î™Î‘</h2>
            <p>Î Î¬Ï„Î± Ï„Î¿ ÎºÎ¿Ï…Î¼Ï€Î¯, Î´Î¹Î¬Î²Î±ÏƒÎµ Ï„Î¿ ÎºÎµÎ¯Î¼ÎµÎ½Î¿ ÎºÎ±Î¸Î±ÏÎ¬ ÎºÎ±Î¹ ÏƒÏ„ÎµÎ¯Î»Îµ Ï„Î¿ Ï†Ï‰Î½Î·Ï„Î¹ÎºÏŒ.</p>
            <div style="background:#333; padding:10px; border-radius:10px; margin:10px 0; font-style:italic;">
                "Î‘Î½Î±Î³Î½Ï‰ÏÎ¯Î¶Ï‰ ÏŒÏ„Î¹ Î®Î¼Î¿Ï…Î½ Î¬Ï„Î±ÎºÏ„Î·. Î¥Ï€ÏŒÏƒÏ‡Î¿Î¼Î±Î¹ Î½Î± Î¼Î·Î½ Î¾Î¿Î´ÎµÏÏ‰ Î±Î»ÏŒÎ³Î¹ÏƒÏ„Î±, Î½Î± Î¼Î·Î½ Î³ÎºÏÎ¹Î½Î¹Î¬Î¶Ï‰ Ï‡Ï‰ÏÎ¯Ï‚ Î»ÏŒÎ³Î¿ ÎºÎ±Î¹ Î½Î± ÎµÎºÏ„Î¹Î¼Ï Ï„Î± Î´ÏÏÎ± Î¼Î¿Ï…."
            </div>
            <button class="btn" id="recordBtn" onmousedown="startRecording()" onmouseup="stopRecording()" ontouchstart="startRecording()" ontouchend="stopRecording()">ğŸ™ï¸ ÎšÏÎ¬Ï„Î± Ï€Î±Ï„Î·Î¼Î­Î½Î¿ Î³Î¹Î± ÎµÎ³Î³ÏÎ±Ï†Î®</button>
            <div id="voiceStatus" style="margin-top:15px;"></div>
        </div>
    </div>

    <div id="cornerUI">
        <div style="font-size:3rem;">ğŸ§±</div>
        <h2 style="color:var(--accent-red); margin:10px;">Î— Î“Î©ÎÎ™Î‘</h2>
        <div id="timerDisplay">02:00</div>
        <p class="corner-msg">ÎœÎ·Î½ ÎºÎ»ÎµÎ¯ÏƒÎµÎ¹Ï‚ Ï„Î·Î½ Î¿Î¸ÏŒÎ½Î·. ÎœÎ·Î½ Î²Î³ÎµÎ¹Ï‚ Î±Ï€ÏŒ Ï„Î¿Î½ browser.<br>Î‘Î½ Ï€Î±Ï„Î®ÏƒÎµÎ¹Ï‚ Î¿Ï€Î¿Ï…Î´Î®Ï€Î¿Ï„Îµ Î±Î»Î»Î¿Ï, Î¿ Ï‡ÏÏŒÎ½Î¿Ï‚ Î±Ï…Î¾Î¬Î½ÎµÏ„Î±Î¹.</p>
        
        <button class="keep-awake-btn" onclick="pokeCorner()">Î Î¬Ï„Î± ÎµÎ´Ï<br>Î±Î½ Î±ÏÎ±Î¹Î¬</button>
        
        <button id="endCornerBtn" class="btn btn-green" style="display:none; width: 200px; margin-top: 30px;" onclick="finishCorner()">ÎˆÎ¼Î±Î¸Î± Ï„Î¿ Î¼Î¬Î¸Î·Î¼Î¬ Î¼Î¿Ï…</button>
    </div>

    <div id="apologyModal" class="modal">
        <div class="modal-content">
            <h2>Î¤Î•Î›Î™ÎšÎŸÎ£ Î•Î›Î•Î“Î§ÎŸÎ£</h2>
            <p>Î–Î®Ï„Î± ÎµÏ…Î³ÎµÎ½Î¹ÎºÎ¬ Î½Î± Î²Î³ÎµÎ¹Ï‚ Î±Ï€ÏŒ Ï„Î·Î½ Ï„Î¹Î¼Ï‰ÏÎ¯Î±. Î£Ï„ÎµÎ¯Î»Îµ Î­Î½Î± Ï„Î±Ï€ÎµÎ¹Î½ÏŒ Ï†Ï‰Î½Î·Ï„Î¹ÎºÏŒ Î¼Î®Î½Ï…Î¼Î±.</p>
            <button class="btn" id="apologyRecBtn" onmousedown="startApologyRec()" onmouseup="stopApologyRec()" ontouchstart="startApologyRec()" ontouchend="stopApologyRec()">ğŸ™ï¸ ÎšÏÎ¬Ï„Î± Ï€Î±Ï„Î·Î¼Î­Î½Î¿ Î³Î¹Î± ÏƒÏ…Î³Î³Î½ÏÎ¼Î·</button>
            
            <div id="analysisUI" style="display:none; margin-top:20px;">
                <p style="color:#00ff00; font-family:monospace;">Î‘Î½Î¬Î»Ï…ÏƒÎ· Ï„ÏŒÎ½Î¿Ï… Ï†Ï‰Î½Î®Ï‚...</p>
                <div class="progress-container"><div class="progress-bar" id="apologyBar"></div></div>
            </div>
        </div>
    </div>

    <div id="extraTimeModal" class="modal">
        <div class="modal-content">
            <div style="font-size:3rem;">ğŸ¤¨</div>
            <h2>Î”Î•Î Î Î•Î™Î£Î¤Î—ÎšÎ‘ÎœÎ•</h2>
            <p>ÎŸ Ï„ÏŒÎ½Î¿Ï‚ Ï„Î·Ï‚ Ï†Ï‰Î½Î®Ï‚ ÏƒÎ¿Ï… Î­Î´ÎµÎ¹Î¾Îµ <strong>12% ÎµÎ¹ÏÏ‰Î½ÎµÎ¯Î±</strong>.</p>
            <p>Î˜Î± ÎºÎ¬Ï„ÏƒÎµÎ¹Ï‚ Î¬Î»Î»Î¿ <strong>1 Î»ÎµÏ€Ï„ÏŒ</strong> ÏƒÏ„Î· Î³Ï‰Î½Î¯Î± Î³Î¹Î± ÏƒÎ¹Î³Î¿Ï…ÏÎ¹Î¬.</p>
            <button class="btn btn-red" onclick="startExtraCorner()">Î•Ï€Î¹ÏƒÏ„ÏÎ¿Ï†Î® ÏƒÏ„Î· Î“Ï‰Î½Î¯Î±</button>
        </div>
    </div>

    <script>
        // ==========================================
        // Î¡Î¥Î˜ÎœÎ™Î£Î•Î™Î£ TELEGRAM (Î’Î‘Î›Î• Î¤Î‘ Î”Î™ÎšÎ‘ Î£ÎŸÎ¥!)
        // ==========================================
        const BOT_TOKEN = '7932574102:AAFQvlNoBw2AWpRuHO7DWlBnRWyA1DhOGuE'; // Î .Ï‡. 712345678:AAH...
        const CHAT_ID = '7336951445';     // Î .Ï‡. 123456789
        // ==========================================

        const dragger = document.getElementById('draggable-name');
        let isDragging = false;
        let startX, currentX;
        const screenWidth = window.innerWidth;

        // DRAG LOGIC (Î‘Ï€Î»Î¿Ï€Î¿Î¹Î·Î¼Î­Î½Î¿ Î³Î¹Î± ÏƒÏ…Î½Ï„Î¿Î¼Î¯Î±)
        dragger.addEventListener('touchstart', (e) => { e.preventDefault(); isDragging = true; startX = e.touches[0].clientX; });
        dragger.addEventListener('touchmove', (e) => { 
            if(!isDragging) return; 
            currentX = e.touches[0].clientX; 
            let delta = currentX - (screenWidth/2);
            dragger.style.transform = `translate(calc(-50% + ${delta}px), -50%) rotate(${delta/10}deg)`;
        });
        dragger.addEventListener('touchend', () => {
            isDragging = false;
            // ÎŒÏ€Î¿Ï… ÎºÎ±Î¹ Î½Î± Ï„Î¿ Ï€Î¬ÎµÎ¹, Ï€Î¬ÎµÎ¹ Ï„Î¹Î¼Ï‰ÏÎ¯Î±
            if(Math.abs(currentX - screenWidth/2) > 50) {
                document.getElementById('punishIntroModal').style.display = 'flex';
            } else {
                dragger.style.transform = `translate(-50%, -50%)`;
            }
        });
        // Mouse support for testing
        dragger.addEventListener('mousedown', () => isDragging = true);
        window.addEventListener('mousemove', (e) => { if(isDragging) { currentX = e.clientX; let delta = currentX - (screenWidth/2); dragger.style.transform = `translate(calc(-50% + ${delta}px), -50%) rotate(${delta/10}deg)`; }});
        window.addEventListener('mouseup', () => { if(isDragging) { isDragging = false; document.getElementById('punishIntroModal').style.display = 'flex'; }});


        // --- PUNISHMENT FLOW ---
        
        function startPunishment() {
            document.getElementById('punishIntroModal').style.display = 'none';
            startQuiz();
        }

        // --- STAGE 1: QUIZ ---
        const questions = [
            { q: "Î Î¿Î¹Î± ÎµÎ¯Î½Î±Î¹ Î· Ï€Î¹Î¿ ÏƒÎ·Î¼Î±Î½Ï„Î¹ÎºÎ® Î±ÏÎµÏ„Î®;", a: ["Î— Î¥Ï€Î¿Î¼Î¿Î½Î®", "Î¤Î¿ Shopping"], correct: 0 },
            { q: "Î Î¿Î¹Î¿Ï‚ Î­Ï‡ÎµÎ¹ Ï€Î¬Î½Ï„Î± Î´Î¯ÎºÎ¹Î¿;", a: ["Î•Î³Ï", "Î•ÏƒÏ (Î¿ Î†Î½Ï„ÏÎ±Ï‚)"], correct: 1 },
            { q: "Î¤Î¹ Î¸Î± ÎºÎ¬Î½ÎµÎ¹Ï‚ Ï†Î­Ï„Î¿Ï‚;", a: ["Î˜Î± ÎµÎ¯Î¼Î±Î¹ ÎºÎ±Î»Î®", "Î˜Î± ÎºÎ¬Î½Ï‰ ÏƒÎºÎ±Î½Ï„Î±Î»Î¹Î­Ï‚"], correct: 0 },
            { q: "Î‘Î¾Î¯Î¶ÎµÎ¹Ï‚ Ï„Î± Î´ÏÏÎ±;", a: ["ÎÎ±Î¹, ÎµÎ¯Î¼Î±Î¹ Î¸ÎµÎ¬", "Î˜Î± Ï€ÏÎ¿ÏƒÏ€Î±Î¸Î®ÏƒÏ‰ Î½Î± Ï„Î± Î±Î¾Î¯Î¶Ï‰"], correct: 1 },
            { q: "Î ÏÏ‚ Î»ÎµÏ‚ ÏƒÏ…Î³Î³Î½ÏÎ¼Î·;", a: ["ÎœÎµ ÏƒÎ¿ÎºÎ¿Î»Î¬Ï„Î±", "ÎœÎµ Ï€ÏÎ¬Î¾ÎµÎ¹Ï‚"], correct: 1 }
        ];
        let qIdx = 0;

        function startQuiz() {
            document.getElementById('stage1Modal').style.display = 'flex';
            showQuestion();
        }

        function showQuestion() {
            if(qIdx >= questions.length) {
                document.getElementById('stage1Modal').style.display = 'none';
                document.getElementById('stage2Modal').style.display = 'flex'; // Go to Writing
                return;
            }
            const q = questions[qIdx];
            document.getElementById('quizQuestion').innerText = q.q;
            document.getElementById('qNum').innerText = qIdx + 1;
            const opts = document.getElementById('quizOptions');
            opts.innerHTML = '';
            q.a.forEach((ans, i) => {
                const btn = document.createElement('button');
                btn.className = 'btn quiz-btn';
                btn.innerText = ans;
                btn.onclick = () => {
                    if(i === q.correct) {
                        qIdx++; showQuestion();
                    } else {
                        alert("Î›Î‘Î˜ÎŸÎ£ Î‘Î Î‘ÎÎ¤Î—Î£Î—! ÎÎ±Î½Î±ÏƒÎºÎ­ÏˆÎ¿Ï… Ï„Î¿.");
                    }
                };
                opts.appendChild(btn);
            });
        }

        // --- STAGE 2: PHOTO UPLOAD ---
        function uploadPhoto() {
            const input = document.getElementById('photoInput');
            const status = document.getElementById('photoStatus');
            
            if(input.files.length === 0) { alert("Î”Î¹Î¬Î»ÎµÎ¾Îµ Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±!"); return; }
            
            status.innerText = "Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î® ÏƒÏ„Î¿ Telegram...";
            const formData = new FormData();
            formData.append('chat_id', CHAT_ID);
            formData.append('photo', input.files[0]);
            formData.append('caption', 'Î‘Ï€Î¿Î´ÎµÎ¹ÎºÏ„Î¹ÎºÏŒ Î¤Î¹Î¼Ï‰ÏÎ¯Î±Ï‚: Î“ÏÎ±Ï†Î®');

            fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`, {
                method: 'POST',
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if(data.ok) {
                    status.innerText = "Î•ÏƒÏ„Î¬Î»Î· ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚! âœ…";
                    setTimeout(() => {
                        document.getElementById('stage2Modal').style.display = 'none';
                        document.getElementById('stage3Modal').style.display = 'flex';
                    }, 1000);
                } else {
                    alert("Î£Ï†Î¬Î»Î¼Î± Î±Ï€Î¿ÏƒÏ„Î¿Î»Î®Ï‚. ÎˆÎ»ÎµÎ³Î¾Îµ Ï„Î¿ Token/Internet.");
                }
            })
            .catch(err => alert("Error: " + err));
        }

        // --- STAGE 3: VOICE ---
        let mediaRecorder;
        let audioChunks = [];

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.addEventListener("dataavailable", event => {
                    audioChunks.push(event.data);
                });
                mediaRecorder.start();
                document.getElementById('recordBtn').style.background = 'red';
                document.getElementById('recordBtn').innerText = 'ğŸ”´ Î•Î³Î³ÏÎ±Ï†Î®...';
            } catch (err) {
                alert("Î§ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÏ„Î¿ Î¼Î¹ÎºÏÏŒÏ†Ï‰Î½Î¿!");
            }
        }

        function stopRecording() {
            if(!mediaRecorder) return;
            mediaRecorder.stop();
            document.getElementById('recordBtn').style.background = 'white';
            document.getElementById('recordBtn').innerText = 'â³ Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î®...';
            
            mediaRecorder.addEventListener("stop", () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/ogg' });
                sendVoiceToTelegram(audioBlob, "ÎŸÎ¼Î¿Î»Î¿Î³Î¯Î±");
            });
        }

        function sendVoiceToTelegram(blob, captionText) {
            const formData = new FormData();
            formData.append('chat_id', CHAT_ID);
            formData.append('voice', blob);
            formData.append('caption', captionText);

            fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendVoice`, {
                method: 'POST',
                body: formData
            }).then(res => {
                if(captionText === "ÎŸÎ¼Î¿Î»Î¿Î³Î¯Î±") {
                    document.getElementById('stage3Modal').style.display = 'none';
                    startCorner(120); // 2 Î»ÎµÏ€Ï„Î¬ (120 Î´ÎµÏ…Ï„ÎµÏÏŒÎ»ÎµÏ€Ï„Î±)
                } else {
                    // Apology logic
                    handleApologySent();
                }
            });
        }

        // --- STAGE 4: THE CORNER ---
        let cornerTime = 0;
        let cornerInterval;
        let servedExtra = false;

        function startCorner(seconds) {
            document.getElementById('cornerUI').style.display = 'flex';
            cornerTime = seconds;
            updateTimerDisplay();
            
            // Anti-cheat Listeners
            document.addEventListener('visibilitychange', handleVisibilityChange);
            document.getElementById('cornerUI').addEventListener('click', handleBadClick);

            cornerInterval = setInterval(() => {
                cornerTime--;
                updateTimerDisplay();
                if(cornerTime <= 0) {
                    clearInterval(cornerInterval);
                    document.getElementById('endCornerBtn').style.display = 'block';
                    document.getElementById('timerDisplay').style.color = '#00ff00';
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const m = Math.floor(cornerTime / 60).toString().padStart(2, '0');
            const s = (cornerTime % 60).toString().padStart(2, '0');
            document.getElementById('timerDisplay').innerText = `${m}:${s}`;
        }

        function handleVisibilityChange() {
            if(document.hidden && document.getElementById('cornerUI').style.display === 'flex') {
                cornerTime = 120; // Reset to full time
                alert("Î Î¿Ï Ï€Î±Ï‚; Î‘Ï€Î±Î³Î¿ÏÎµÏÎµÏ„Î±Î¹ Î½Î± Î²Î³ÎµÎ¹Ï‚! ÎŸ Ï‡ÏÏŒÎ½Î¿Ï‚ Î¾ÎµÎºÎ¹Î½Î¬ÎµÎ¹ Î±Ï€ÏŒ Ï„Î·Î½ Î±ÏÏ‡Î®!");
            }
        }

        function handleBadClick(e) {
            // Î‘Î½ Ï€Î±Ï„Î®ÏƒÎµÎ¹ ÏƒÏ„Î¿ background ÎºÎ±Î¹ ÏŒÏ‡Î¹ ÏƒÏ„Î± ÎºÎ¿Ï…Î¼Ï€Î¹Î¬
            if(e.target.id === 'cornerUI') {
                cornerTime += 10;
                // Visual feedback (shake)
                const timer = document.getElementById('timerDisplay');
                timer.style.color = 'red';
                setTimeout(() => timer.style.color = 'white', 200);
            }
        }

        function pokeCorner() {
            // Just a dummy button to keep interaction alive
            console.log("Still here");
        }

        function finishCorner() {
            document.removeEventListener('visibilitychange', handleVisibilityChange);
            document.getElementById('cornerUI').removeEventListener('click', handleBadClick);
            document.getElementById('cornerUI').style.display = 'none';
            document.getElementById('apologyModal').style.display = 'flex';
        }

        // --- FINAL APOLOGY & EXTRA TIME ---
        
        // Wrapper functions for the apology button
        async function startApologyRec() { startRecording(); } 
        // Note: startRecording is generic, but we need to override the stop logic or pass a flag.
        // Simplified: reusing logic but we need to know context.
        // Let's create specific handlers for apology to be safe.

        let apologyRecorder;
        let apologyChunks = [];

        async function startApologyRec() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                apologyRecorder = new MediaRecorder(stream);
                apologyChunks = [];
                apologyRecorder.addEventListener("dataavailable", e => apologyChunks.push(e.data));

                apologyRecorder.start();
                document.getElementById('apologyRecBtn').style.background = 'red';
            } catch(e) { alert("Mic error"); }
        }

        function stopApologyRec() {
            if(!apologyRecorder) return;
            apologyRecorder.stop();
            document.getElementById('apologyRecBtn').style.background = 'white';
            
            apologyRecorder.addEventListener("stop", () => {
                const blob = new Blob(apologyChunks, {type: 'audio/ogg'});
                // Fake UI Analysis
                document.getElementById('analysisUI').style.display = 'block';
                document.getElementById('apologyBar').style.width = '100%';
                
                // Upload in background
                const formData = new FormData();
                formData.append('chat_id', CHAT_ID);
                formData.append('voice', blob);
                formData.append('caption', servedExtra ? "Î¤ÎµÎ»Î¹ÎºÎ® Î£Ï…Î³Î³Î½ÏÎ¼Î· (Approved)" : "Î ÏÏÏ„Î· Î£Ï…Î³Î³Î½ÏÎ¼Î· (Rejected)");
                fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendVoice`, { method: 'POST', body: formData });

                setTimeout(() => {
                    handleApologyResult();
                }, 2000);
            });
        }

        function handleApologyResult() {
            document.getElementById('apologyModal').style.display = 'none';
            
            if(!servedExtra) {
                // First time -> Fail -> Extra Time
                document.getElementById('extraTimeModal').style.display = 'flex';
                servedExtra = true;
            } else {
                // Second time -> Success -> Return to Map
                window.location.href = 'index.html?evaluated=true';
            }
        }

        function startExtraCorner() {
            document.getElementById('extraTimeModal').style.display = 'none';
            document.getElementById('endCornerBtn').style.display = 'none'; // Hide finish button again
            document.getElementById('timerDisplay').style.color = 'var(--accent-red)';
            startCorner(60); // 1 minute extra
        }

    </script>
</body>
</html>
          
