<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Î— ÎœÎµÎ³Î¬Î»Î· Î¤Î¹Î¼Ï‰ÏÎ¯Î± ğŸ“œ</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #1a1a1a;
            --accent-red: #ff3333;
            --text-color: #f0f0f0;
            --flag-green: #009246;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            margin: 0; padding: 0; height: 100vh; overflow: hidden;
            background: var(--bg-color); color: var(--text-color);
            display: flex; flex-direction: column; user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        h1 {
            text-align: center; margin: 15px 0; z-index: 10; font-size: 1.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            position: absolute; width: 100%; top: 0; pointer-events: none;
        }

        /* CONTAINER ZONES */
        .container { display: flex; width: 100%; height: 100%; }
        .zone {
            width: 50%; height: 100%; display: flex; flex-direction: column;
            justify-content: center; align-items: center; transition: opacity 0.3s;
        }
        .naughty { background: linear-gradient(135deg, #8b0000, #500000); border-right: 1px solid #ffffff33; }
        .nice { background: linear-gradient(135deg, #006400, #004d00); }
        .icon { font-size: 3rem; opacity: 0.6; margin-bottom: 10px; }
        .zone-title { font-size: 1.2rem; font-weight: 900; opacity: 0.8; letter-spacing: 2px; }

        /* DRAGGABLE */
        #draggable-name {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; color: #333; padding: 15px 30px; border-radius: 50px;
            font-size: 1.2rem; font-weight: 800; box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            cursor: grab; z-index: 100; touch-action: none; border: 4px solid #d4af37;
        }

        /* MODALS */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 200;
            justify-content: center; align-items: center; padding: 20px; box-sizing: border-box;
        }

        .modal-content {
            background: #222; color: white; text-align: center; padding: 25px;
            border-radius: 20px; width: 100%; max-width: 400px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8); border: 1px solid #444;
            max-height: 85vh; overflow-y: auto; position: relative;
        }

        /* TEXT & BUTTONS */
        h2 { color: var(--accent-red); margin-top: 0; font-size: 1.5rem; }
        h3 { color: #aaa; font-size: 1.1rem; margin-bottom: 15px; }
        p { line-height: 1.6; color: #ccc; font-size: 0.95rem; margin-bottom: 20px; }

        .btn {
            background: white; color: black; border: none; padding: 15px 30px;
            font-size: 1rem; font-weight: bold; border-radius: 50px; cursor: pointer;
            width: 100%; margin-top: 10px; transition: transform 0.1s;
            box-shadow: 0 5px 15px rgba(255,255,255,0.1);
        }
        .btn:active { transform: scale(0.95); }
        .btn:disabled { background: #555; color: #888; cursor: wait; transform: none; }
        .btn-red { background: var(--accent-red); color: white; }
        .btn-green { background: var(--flag-green); color: white; }
        .quiz-btn { background: #333; color: white; border: 1px solid #555; text-align: left; }
        
        /* NOSE BUTTON STYLES */
        #noseVideo {
            width: 100%; height: 180px; object-fit: cover; border-radius: 10px;
            border: 2px solid #555; background: #000; margin-bottom: 10px; transform: scaleX(-1);
        }
        .nose-btn {
            width: 120px; height: 120px; border-radius: 50%;
            background: radial-gradient(circle, #ff5555, #990000);
            border: 5px solid white; color: white; font-size: 1rem; font-weight: 900;
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.5);
            margin: 10px auto; display: flex; justify-content: center; align-items: center;
            cursor: pointer; user-select: none; -webkit-touch-callout: none;
            touch-action: manipulation; text-align: center; line-height: 1.2;
        }
        .nose-btn:active { transform: scale(0.9); border-color: #00ff00; background: radial-gradient(circle, #009900, #005500); }

        /* CORNER UI */
        #cornerUI {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: black; z-index: 500; flex-direction: column;
            justify-content: center; align-items: center; color: white;
        }
        #timerDisplay { font-size: 5rem; font-weight: 900; font-family: monospace; color: var(--accent-red); transition: color 0.3s; }
        .keep-awake-btn {
            margin-top: 50px; padding: 20px; border-radius: 50%; width: 100px; height: 100px;
            background: #333; border: 2px solid #555; color: #888; font-size: 0.8rem;
        }

        /* LOADING BAR */
        .progress-container { width: 100%; height: 20px; background: #444; border-radius: 10px; margin-top: 15px; overflow: hidden; border: 1px solid #666; }
        .progress-bar { width: 0%; height: 100%; background: linear-gradient(90deg, #ff9900, #ff0000); transition: width 0.1s linear; }
        
        .info-text { font-style: italic; color: #ddd; margin-bottom: 20px; }
        
        /* INPUTS */
        textarea, input[type="text"] {
            width: 100%; background: #333; color: white; 
            border: 1px solid #555; border-radius: 10px; padding: 10px; 
            font-family: inherit; resize: none; box-sizing: border-box; font-size: 1rem;
        }
        
        #typingInput { text-align: center; font-weight: bold; margin-bottom: 10px; }
        
        /* Audio visualizer for nose */
        #voiceIndicator {
            width: 20px; height: 20px; border-radius: 50%; background: #333; 
            display: inline-block; margin-left: 10px; border: 2px solid #555;
        }

    </style>
</head>
<body>

    <div id="checkInModal" class="modal" style="display:flex; z-index: 5000;">
        <div class="modal-content">
            <div style="font-size: 4rem;">ğŸ›‚</div>
            <h2>CHECK-IN</h2>
            <p>ÎÏÎ± Î³Î¹Î± Î±Î¾Î¹Î¿Î»ÏŒÎ³Î·ÏƒÎ· ÎºÎ±Î¹ Î­Î»ÎµÎ³Ï‡Î¿ Î´Î¹Î±Î²Î±Ï„Î·ÏÎ¯Ï‰Î½.</p>
            <p style="color:#aaa;">Î•Î»Ï€Î¯Î¶Ï‰ Î½Î± Î®ÏƒÎ¿Ï…Î½ ÎºÎ±Î»ÏŒ ÎºÎ¿ÏÎ¯Ï„ÏƒÎ¹...</p>
            <button class="btn btn-green" onclick="closeCheckIn()">ÎÎµÎºÎ¯Î½Î±</button>
        </div>
    </div>

    <h1>ÎšÎ¡Î™Î£Î— & Î¤Î™ÎœÎ©Î¡Î™Î‘ âš–ï¸</h1>

    <div class="container" id="dragGame">
        <div class="zone naughty" id="zone-naughty">
            <div class="icon">ğŸ˜ˆ</div>
            <div class="zone-title">NAUGHTY</div>
        </div>
        <div class="zone nice" id="zone-nice">
            <div class="icon">ğŸ˜‡</div>
            <div class="zone-title">NICE</div>
        </div>
    </div>
    <div id="draggable-name">Î£Î‘Î¡Î‘</div>


    <div id="evalQuizModal" class="modal">
        <div class="modal-content">
            <h2 style="color:var(--flag-green);">Î‘ÎÎ™ÎŸÎ›ÎŸÎ“Î—Î£Î—</h2>
            <div id="evalQuestion" style="font-weight:bold; font-size:1.1rem; margin-bottom:15px; color:#fff;"></div>
            <div id="evalOptions"></div>
        </div>
    </div>

    <div id="analysisModal" class="modal">
        <div class="modal-content">
            <div style="font-size: 3rem;">ğŸ¤–</div>
            <h2 style="color: #00ff00;">Î‘ÎÎ‘Î›Î¥Î£Î—</h2>
            <p id="analysisText">Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± Î±Ï€Î±Î½Ï„Î®ÏƒÎµÏ‰Î½...</p>
            <div class="progress-container" style="height:10px;"><div class="progress-bar" id="analysisBar" style="background:var(--flag-green);"></div></div>
        </div>
    </div>


    <div id="punishIntroModal" class="modal">
        <div class="modal-content">
            <div style="font-size: 4rem;">ğŸš¨</div>
            <h2>Î•Î§Î•Î™Î£ ÎšÎ¡Î™Î˜Î•Î™ Î•ÎÎŸÎ§Î—!</h2>
            <p>Î¤Î¿ ÏƒÏÏƒÏ„Î·Î¼Î± ÎµÎ½Ï„ÏŒÏ€Î¹ÏƒÎµ Ï€Î¿Î»Î»Î±Ï€Î»Î­Ï‚ Ï€Î±ÏÎ±Î²Î¬ÏƒÎµÎ¹Ï‚. Î”ÎµÎ½ Î¼Ï€Î¿ÏÎµÎ¯Ï‚ Î½Î± ÏƒÏ…Î½ÎµÏ‡Î¯ÏƒÎµÎ¹Ï‚ Ï„Î¿ Ï„Î±Î¾Î¯Î´Î¹ Î±Î½ Î´ÎµÎ½ ÎµÎºÏ„Î¯ÏƒÎµÎ¹Ï‚ Ï„Î·Î½ Ï€Î¿Î¹Î½Î® ÏƒÎ¿Ï….</p>
            <button class="btn btn-red" onclick="startReasonModal()">Î‘Ï€Î¿Î´Î¿Ï‡Î® Î¤Î¹Î¼Ï‰ÏÎ¯Î±Ï‚</button>
        </div>
    </div>
    
    <div id="reasonModal" class="modal">
        <div class="modal-content">
            <h2>ÎŸÎœÎŸÎ›ÎŸÎ“Î™Î‘</h2>
            <p>Î ÏÎ¹Î½ Î¾ÎµÎºÎ¹Î½Î®ÏƒÎ¿Ï…Î¼Îµ, Î³ÏÎ¬ÏˆÎµ Ï„Î¿Î½ Î»ÏŒÎ³Î¿ Ï€Î¿Ï… Ï„Î¹Î¼Ï‰ÏÎµÎ¯ÏƒÎ±Î¹.</p>
            <p style="font-size:0.8rem; color:#888; margin-bottom:5px;">(Î“ÏÎ¬ÏˆÎµ: "ÎœÏ€Î±Î¯Î½Ï‰ Ï„Î¹Î¼Ï‰ÏÎ¯Î± Î³Î¹Î±Ï„Î¯...")</p>
            <textarea id="reasonInput" placeholder="Î“ÏÎ¬ÏˆÎµ ÎµÎ´Ï Ï„Î¿Î½ Î»ÏŒÎ³Î¿..."></textarea>
            <button class="btn btn-red" onclick="sendReason()">Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î® & ÎˆÎ½Î±ÏÎ¾Î·</button>
        </div>
    </div>

    <div id="infoPreQuiz" class="modal">
        <div class="modal-content">
            <h3>Î’Î®Î¼Î± 1</h3>
            <p class="info-text">"Î“Î¹Î± Î½Î± Î´Î¿ÏÎ¼Îµ Î±Î½ Î­Î²Î±Î»ÎµÏ‚ Î¼Ï…Î±Î»ÏŒ... Î‘Ï€Î¬Î½Ï„Î·ÏƒÎµ ÏƒÏ‰ÏƒÏ„Î¬ ÏƒÏ„Î¹Ï‚ ÎµÏÏ‰Ï„Î®ÏƒÎµÎ¹Ï‚."</p>
            <button class="btn" onclick="startPunishQuiz()">Î£Ï…Î½Î­Ï‡ÎµÎ¹Î±</button>
        </div>
    </div>

    <div id="punishQuizModal" class="modal">
        <div class="modal-content">
            <h2>Î£Î¤Î‘Î”Î™ÎŸ 1: Î‘ÎÎ‘ÎšÎ¡Î™Î£Î—</h2>
            <div id="punishQuestion" style="font-weight:bold; font-size:1.1rem; margin-bottom:15px; color:#fff;"></div>
            <div id="punishOptions"></div>
        </div>
    </div>

    <div id="infoPreTyping" class="modal">
        <div class="modal-content">
            <h3>Î’Î®Î¼Î± 2: Î¤Î‘Î§Î¥Î¤Î—Î¤Î‘</h3>
            <p class="info-text">"Î ÏÎ­Ï€ÎµÎ¹ Î½Î± Ï„Î¿ Î³ÏÎ¬ÏˆÎµÎ¹Ï‚ ÎºÎ±Î¹ ÎµÎ´Ï, Î³ÏÎ®Î³Î¿ÏÎ± ÎºÎ±Î¹ ÏƒÏ‰ÏƒÏ„Î¬!"</p>
            <button class="btn" onclick="startTyping()">ÎÎµÎºÎ¯Î½Î±</button>
        </div>
    </div>

    <div id="typingModal" class="modal">
        <div class="modal-content">
            <h2>Î”Î‘ÎšÎ¤Î¥Î›ÎŸÎ“Î¡Î‘Î¦Î—Î£Î—</h2>
            <p>Î“ÏÎ¬ÏˆÎµ Î±ÎºÏÎ¹Î²ÏÏ‚ Ï„Î· Ï†ÏÎ¬ÏƒÎ·:</p>
            <div style="background:#333; padding:10px; border-radius:10px; margin-bottom:10px; color:#00ff00; font-weight:bold;">
                Î˜Î± ÎµÎ¯Î¼Î±Î¹ Ï†ÏÏŒÎ½Î¹Î¼Î· ÎºÎ±Î¹ Ï…Ï€Î¬ÎºÎ¿Ï…Î·
            </div>
            
            <div class="progress-container" style="height:25px; margin-bottom:15px;">
                <div class="progress-bar" id="typingBar"></div>
            </div>

            <input type="text" id="typingInput" placeholder="Î“ÏÎ¬ÏˆÎµ ÎµÎ´Ï..." autocomplete="off">
            <button class="btn btn-red" onclick="submitTyping()">Î¥Ï€Î¿Î²Î¿Î»Î®</button>
            <div id="typingError" style="color:var(--accent-red); margin-top:10px; font-weight:bold; min-height:20px;"></div>
            <p style="font-size:0.8rem; color:#888;">Î’Î¹Î¬ÏƒÎ¿Ï…! Î— Î¼Ï€Î¬ÏÎ± Ï€Î­Ï†Ï„ÎµÎ¹!</p>
        </div>
    </div>

    <div id="infoPrePose" class="modal">
        <div class="modal-content">
            <h3>Î’Î®Î¼Î± 3</h3>
            <p class="info-text">"Î¤ÏÏÎ± Î¸Î­Î»Ï‰ Î½Î± Î´Ï‰ ÏŒÏ„Î¹ Î½Ï„ÏÎ­Ï€ÎµÏƒÎ±Î¹ Ï€ÏÎ±Î³Î¼Î±Ï„Î¹ÎºÎ¬. Î Î¬ÏÎµ Ï„Î¿ Ï€Î¹Î¿ Ï„Î±Ï€ÎµÎ¹Î½ÏŒ ÏƒÎ¿Ï… ÏÏ†Î¿Ï‚."</p>
            <button class="btn" onclick="startPose()">Î£Ï…Î½Î­Ï‡ÎµÎ¹Î±</button>
        </div>
    </div>

    <div id="poseModal" class="modal">
        <div class="modal-content">
            <h2>Î•ÎÎ”Î™Î‘ÎœÎ•Î£ÎŸ: Î¤Î‘Î Î•Î™ÎÎ©Î£Î—</h2>
            <p>Î’Î³Î¬Î»Îµ Î¼Î¹Î± selfie Î¼Îµ Ï„Î¿ Ï€Î¹Î¿ <strong>Ï„Î±Ï€ÎµÎ¹Î½ÏŒ, Î¼ÎµÏ„Î±Î½Î¹Ï‰Î¼Î­Î½Î¿ ÏÏ†Î¿Ï‚</strong> Ï€Î¿Ï… Î­Ï‡ÎµÎ¹Ï‚.</p>
            <input type="file" id="poseInput" accept="image/*" style="color:white; margin: 10px 0;">
            <button class="btn btn-red" id="btnUploadPose" onclick="compressAndUpload('poseInput', 'ğŸ“¸ Î‘Ï€Î¿Î´ÎµÎ¹ÎºÏ„Î¹ÎºÏŒ: Î¤Î±Ï€ÎµÎ¹Î½ÏŒ ÎÏ†Î¿Ï‚', finishPose)">Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î® Î¦ÏÏ„Î¿</button>
            <div id="poseStatus" style="margin-top:10px; color:#aaa; font-size:0.8rem;"></div>
        </div>
    </div>

    <div id="infoPreNose" class="modal">
        <div class="modal-content">
            <h3>Î’Î®Î¼Î± 4: Î— ÎœÎ¥Î¤Î—</h3>
            <p class="info-text">"Î‰ÏÎ¸Îµ Î· ÏÏÎ± Ï„Î·Ï‚ ÎºÏÎ¯ÏƒÎ·Ï‚. Î˜Î± Ï€Î±Ï„Î®ÏƒÎµÎ¹Ï‚ Ï„Î¿ ÎºÎ¿Ï…Î¼Ï€Î¯ Î¼Îµ Ï„Î· <strong>ÎœÎ¥Î¤Î—</strong> ÏƒÎ¿Ï…."</p>
            <p class="info-text" style="color:var(--accent-red);">
                <strong>Î Î¡ÎŸÎ£ÎŸÎ§Î—:</strong><br>
                1. ÎœÎ·Î½ ÏƒÎ·ÎºÏÏƒÎµÎ¹Ï‚ Ï„Î· Î¼ÏÏ„Î· ÏƒÎ¿Ï….<br>
                2. Î¤Î±Ï…Ï„ÏŒÏ‡ÏÎ¿Î½Î± Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± Î»ÎµÏ‚ Î”Î¥ÎÎ‘Î¤Î‘:<br>
                <em>"Î‰Î¼Î¿Ï…Î½ Î¬Ï„Î±ÎºÏ„Î· ÎºÎ±Î¹ Î±Î½Ï…Ï€Î¬ÎºÎ¿Ï…Î·"</em><br>
                Î‘Î½ ÏƒÏ„Î±Î¼Î±Ï„Î®ÏƒÎµÎ¹Ï‚ Î½Î± Î¼Î¹Î»Î¬Ï‚, Ï‡Î¬Î½ÎµÎ¹Ï‚!
            </p>
            <button class="btn btn-red" onclick="initNoseStage()">Î•Î¯Î¼Î±Î¹ Î­Ï„Î¿Î¹Î¼Î·</button>
        </div>
    </div>

    <div id="noseModal" class="modal">
        <div class="modal-content">
            <h2>Î”ÎŸÎšÎ™ÎœÎ‘Î£Î™Î‘ ÎœÎ¥Î¤Î—Î£</h2>
            <video id="noseVideo" autoplay playsinline muted></video>
            
            <div style="display:flex; align-items:center; justify-content:center; margin:10px;">
                <div id="noseTimer" style="font-size:2.5rem; font-weight:900; color:var(--accent-red);">30.0</div>
                <div id="voiceIndicator"></div>
            </div>
            
            <div class="nose-btn" id="noseBtn" 
                 onmousedown="startNoseHold()" onmouseup="endNoseHold()" 
                 ontouchstart="startNoseHold(event)" ontouchend="endNoseHold(event)">
                Î Î‘Î¤Î‘ ÎœÎ• Î¤Î— ÎœÎ¥Î¤Î—
            </div>
            <p id="noseMsg" style="font-size:0.8rem; color:#aaa; margin-top:10px;">
                ÎšÏÎ¬Ï„Î± & ÎœÎ¯Î»Î±: "Î‰Î¼Î¿Ï…Î½ Î¬Ï„Î±ÎºÏ„Î· ÎºÎ±Î¹ Î±Î½Ï…Ï€Î¬ÎºÎ¿Ï…Î·"
            </p>
        </div>
    </div>

    <div id="infoPreWrite" class="modal">
        <div class="modal-content">
            <h3>Î’Î®Î¼Î± 5</h3>
            <p class="info-text">"ÎÏÎ± Î³Î¹Î± ÎµÎ¾Î¬ÏƒÎºÎ·ÏƒÎ·. Î Î¬ÏÎµ Ï‡Î±ÏÏ„Î¯ ÎºÎ±Î¹ ÏƒÏ„Ï…Î»ÏŒ Î¤Î©Î¡Î‘!"</p>
            <button class="btn" onclick="startHandwriting()">Î£Ï…Î½Î­Ï‡ÎµÎ¹Î±</button>
        </div>
    </div>

    <div id="handwritingModal" class="modal">
        <div class="modal-content">
            <h2>Î£Î¤Î‘Î”Î™ÎŸ 5: Î“Î¡Î‘Î¦Î—</h2>
            <p>Î“ÏÎ¬ÏˆÎµ <strong>10 Ï†Î¿ÏÎ­Ï‚</strong>:</p>
            <div style="background:#333; padding:10px; border-radius:10px; margin:10px 0; color:#00ff00; font-family:monospace;">
                "SarÃ² una brava ragazza quest'anno"
            </div>
            <p>Î‘Î½Î­Î²Î±ÏƒÎµ Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±:</p>
            <input type="file" id="photoInput" accept="image/*" style="color:white;">
            <button class="btn btn-red" id="btnUploadWrite" onclick="compressAndUpload('photoInput', 'ğŸ“¸ Î‘Ï€Î¿Î´ÎµÎ¹ÎºÏ„Î¹ÎºÏŒ: Î“ÏÎ±Ï†Î®', finishHandwriting)">Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î®</button>
            <div id="photoStatus" style="margin-top:10px; color:#aaa; font-size:0.8rem;"></div>
        </div>
    </div>

    <div id="infoPreCorner" class="modal">
        <div class="modal-content">
            <h3>Î’Î®Î¼Î± 6</h3>
            <p class="info-text">"ÎšÎ±Î¹ Ï„ÏÏÎ±... ÏƒÏ„Î· Î“Î©ÎÎ™Î‘! Î£ÎºÎ­ÏˆÎ¿Ï… Ï„Î¹ Î­ÎºÎ±Î½ÎµÏ‚. ÎœÎ·Î½ Ï„Î¿Î»Î¼Î®ÏƒÎµÎ¹Ï‚ Î½Î± Î²Î³ÎµÎ¹Ï‚."</p>
            <button class="btn btn-red" onclick="startCorner(2)">Î Î®Î³Î±Î¹Î½Îµ ÏƒÏ„Î· Î“Ï‰Î½Î¯Î±</button>
        </div>
    </div>

    <div id="cornerUI">
        <div style="font-size:3rem;">ğŸ§±</div>
        <h2 style="color:var(--accent-red); margin:10px;">Î— Î“Î©ÎÎ™Î‘</h2>
        <div id="timerDisplay">02:00</div>
        <p style="color:#666; font-size:0.9rem; text-align:center; padding:0 20px;">
            ÎœÎ·Î½ ÎºÎ»ÎµÎ¯ÏƒÎµÎ¹Ï‚ Ï„Î·Î½ Î¿Î¸ÏŒÎ½Î·.<br>Î‘Î½ Î²Î³ÎµÎ¹Ï‚ Î±Ï€ÏŒ ÎµÎ´Ï, Ï€ÏÎ¿ÏƒÏ„Î¯Î¸ÎµÏ„Î±Î¹ Ï‡ÏÏŒÎ½Î¿Ï‚ (+10s).
        </p>
        <button class="keep-awake-btn" onclick="pokeCorner()">Touch me</button>
        <button id="endCornerBtn" class="btn btn-green" style="display:none; width: 200px; margin-top: 30px;" onclick="finishCorner()">ÎˆÎ¼Î±Î¸Î± Ï„Î¿ Î¼Î¬Î¸Î·Î¼Î¬ Î¼Î¿Ï…</button>
    </div>

    <div id="apologyModal" class="modal">
        <div class="modal-content">
            <h2>Î¤Î•Î›Î™ÎšÎŸÎ£ Î•Î›Î•Î“Î§ÎŸÎ£</h2>
            <p>Î–Î®Ï„Î± ÎµÏ…Î³ÎµÎ½Î¹ÎºÎ¬ Î½Î± Î²Î³ÎµÎ¹Ï‚. Î£Ï„ÎµÎ¯Î»Îµ Ï„Î±Ï€ÎµÎ¹Î½ÏŒ Ï†Ï‰Î½Î·Ï„Î¹ÎºÏŒ.</p>
            <button class="btn" id="apologyRecBtn" onmousedown="startApologyRec()" onmouseup="stopApologyRec()" ontouchstart="startApologyRec()" ontouchend="stopApologyRec()">ğŸ™ï¸ Î£Ï…Î³Î³Î½ÏÎ¼Î·</button>
            <div id="analysisUI" style="display:none; margin-top:20px;">
                <p style="color:#00ff00; font-family:monospace; font-size:0.8rem;">Î‘Î½Î¬Î»Ï…ÏƒÎ· ÎµÎ¹Î»Î¹ÎºÏÎ¯Î½ÎµÎ¹Î±Ï‚...</p>
                <div class="progress-container"><div class="progress-bar" id="apologyBar"></div></div>
            </div>
        </div>
    </div>

    <div id="extraTimeModal" class="modal">
        <div class="modal-content">
            <div style="font-size:3rem;">ğŸ¤¨</div>
            <h2>Î”Î•Î Î Î•Î™Î£Î¤Î—ÎšÎ‘ÎœÎ•</h2>
            <p>ÎŸ Ï„ÏŒÎ½Î¿Ï‚ Ï„Î·Ï‚ Ï†Ï‰Î½Î®Ï‚ ÏƒÎ¿Ï… Î­Î´ÎµÎ¹Î¾Îµ <strong>ÎµÎ¹ÏÏ‰Î½ÎµÎ¯Î±</strong>.</p>
            <p>Î˜Î± ÎºÎ¬Ï„ÏƒÎµÎ¹Ï‚ Î¬Î»Î»Î¿ <strong>1 Î»ÎµÏ€Ï„ÏŒ</strong> ÏƒÏ„Î· Î³Ï‰Î½Î¯Î±.</p>
            <button class="btn btn-red" onclick="startExtraCorner()">Î Î¯ÏƒÏ‰ ÏƒÏ„Î· Î“Ï‰Î½Î¯Î±</button>
        </div>
    </div>

    <div id="successModal" class="modal">
        <div class="modal-content">
            <div style="font-size: 3rem;">ğŸ‰</div>
            <h2 style="color:var(--flag-green);">Î•Î¤Î£Î™ ÎœÎ Î¡Î‘Î’ÎŸ!</h2>
            <p>Î¤ÏÏÎ± Î¼Ï€Î¿ÏÎµÎ¯Ï‚ Î½Î± Î¾ÎµÎºÎ¹Î½Î®ÏƒÎµÎ¹Ï‚ Ï„Î¿ Ï„Î±Î¾Î¯Î´Î¹ ÏƒÎ¿Ï…!</p>
            <button class="btn btn-green" onclick="finishPunishment()">OK</button>
        </div>
    </div>

    <script>
        // ==========================================
        // âš ï¸ Î£Î¤ÎŸÎ™Î§Î•Î™Î‘ BOT âš ï¸
        // ==========================================
        const BOT_TOKEN = '7932574102:AAFQvlNoBw2AWpRuHO7DWlBnRWyA1DhOGuE'; 
        const CHAT_ID = '7336951445';    
        // ==========================================

        const dragger = document.getElementById('draggable-name');
        let isDragging = false;
        let startX, currentX;
        const screenWidth = window.innerWidth;

        // INITIAL CHECK IN
        function closeCheckIn() {
            document.getElementById('checkInModal').style.display = 'none';
        }

        // --- HELPER FOR NOTIFICATIONS ---
        function sendTelegramNotification(text) {
            fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ chat_id: CHAT_ID, text: text })
            });
        }

        // --- DRAG LOGIC ---
        dragger.addEventListener('touchstart', (e) => { e.preventDefault(); isDragging = true; startX = e.touches[0].clientX; });
        dragger.addEventListener('touchmove', (e) => { 
            if(!isDragging) return; 
            currentX = e.touches[0].clientX; 
            let delta = currentX - (screenWidth/2);
            dragger.style.transform = `translate(calc(-50% + ${delta}px), -50%) rotate(${delta/10}deg)`;
        });
        dragger.addEventListener('touchend', endDrag);
        dragger.addEventListener('mousedown', () => isDragging = true);
        window.addEventListener('mousemove', (e) => { if(isDragging) { currentX = e.clientX; let delta = currentX - (screenWidth/2); dragger.style.transform = `translate(calc(-50% + ${delta}px), -50%) rotate(${delta/10}deg)`; }});
        window.addEventListener('mouseup', endDrag);

        function endDrag() {
            if(!isDragging) return;
            isDragging = false;
            if(currentX < screenWidth * 0.3) {
                document.getElementById('punishIntroModal').style.display = 'flex';
            } else if(currentX > screenWidth * 0.7) {
                startEvalQuiz();
            } else {
                dragger.style.transform = `translate(-50%, -50%)`;
            }
        }

        // --- EVALUATION ---
        const evalQuestions = [
            { q: "Î‰ÏƒÎ¿Ï…Î½ Ï†ÏÏŒÎ½Î¹Î¼Î·;", a: ["ÎÎ±Î¹, Î±Î³Î³ÎµÎ»Î¿ÏÎ´Î¹ ğŸ˜‡", "Î•Ï‡Î¼... Î¯ÏƒÏ‰Ï‚; ğŸ˜ˆ"] },
            { q: "ÎÏŒÎ´ÎµÏˆÎµÏ‚ Ï€Î¿Î»Î»Î¬;", a: ["ÎŒÏ‡Î¹ Î²Î­Î²Î±Î¹Î±", "Î¤Î± Ï€Î¬Î½Ï„Î± ğŸ’¸"] },
            { q: "Î Î¿Î¹Î¿Ï‚ ÎµÎ¯Î½Î±Î¹ Î¿ Ï€Î¹Î¿ Ï‰ÏÎ±Î¯Î¿Ï‚;", a: ["Î•ÏƒÏ â¤ï¸", "ÎŸ Brad Pitt"] },
            { q: "ÎˆÏ†Î±Î³ÎµÏ‚ Î³Î»Ï…ÎºÎ¬;", a: ["ÎœÏ€Î±...", "ÎŒÎ»Î±! ğŸ«"] },
            { q: "ÎœÎ¿Ï… Ï€Î®ÏÎµÏ‚ Î´ÏÏÎ¿;", a: ["Î¤Î¿ ÎºÎ±Î»ÏÏ„ÎµÏÎ¿ ğŸ", "Î˜Î± Î´Î¿ÏÎ¼Îµ"] }
        ];
        let evalIdx = 0;
        let evalAnswers = [];

        function startEvalQuiz() {
            document.getElementById('evalQuizModal').style.display = 'flex';
            showEvalQuestion();
        }

        function showEvalQuestion() {
            if(evalIdx >= evalQuestions.length) {
                document.getElementById('evalQuizModal').style.display = 'none';
                sendTelegramNotification("ğŸ“ Î‘Ï€Î±Î½Ï„Î®ÏƒÎµÎ¹Ï‚ Î‘Î¾Î¹Î¿Î»ÏŒÎ³Î·ÏƒÎ·Ï‚:\n" + evalAnswers.join("\n"));
                startAnalysis();
                return;
            }
            const q = evalQuestions[evalIdx];
            document.getElementById('evalQuestion').innerText = q.q;
            const opts = document.getElementById('evalOptions');
            opts.innerHTML = '';
            q.a.forEach((ans) => {
                const btn = document.createElement('button');
                btn.className = 'btn quiz-btn';
                btn.style.color = 'black'; btn.style.background = '#f0f0f0';
                btn.innerText = ans;
                btn.onclick = () => { 
                    evalAnswers.push(`Q: ${q.q} -> A: ${ans}`);
                    evalIdx++; showEvalQuestion(); 
                };
                opts.appendChild(btn);
            });
        }

        function startAnalysis() {
            const modal = document.getElementById('analysisModal');
            const txt = document.getElementById('analysisText');
            const bar = document.getElementById('analysisBar');
            modal.style.display = 'flex';
            let progress = 0;
            const steps = ["Î£Î¬ÏÏ‰ÏƒÎ·...", "ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚...", "Î‘Î½Î¬Î»Ï…ÏƒÎ·...", "Î‘Î ÎŸÎ¤Î•Î›Î•Î£ÎœÎ‘: Î•ÎÎŸÎ§Î— âŒ"];
            
            const interval = setInterval(() => {
                progress += 20; bar.style.width = progress + "%";
                if(progress/20 < steps.length) txt.innerText = steps[progress/20];
                if(progress >= 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        modal.style.display = 'none';
                        document.getElementById('punishIntroModal').style.display = 'flex';
                    }, 1500);
                }
            }, 1000);
        }

        // --- PUNISHMENT FLOW ---
        function startReasonModal() {
            document.getElementById('punishIntroModal').style.display = 'none';
            document.getElementById('reasonModal').style.display = 'flex';
        }

        function sendReason() {
            const input = document.getElementById('reasonInput');
            const text = input.value;
            if(text.trim().length < 5) { alert("Î“ÏÎ¬ÏˆÎµ Î¿Î»ÏŒÎºÎ»Î·ÏÎ· Ï€ÏÏŒÏ„Î±ÏƒÎ·!"); return; }

            const btn = document.querySelector('#reasonModal .btn');
            btn.innerText = "Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î®..."; btn.disabled = true;

            const msg = `ğŸ“ *ÎŸÎ¼Î¿Î»Î¿Î³Î¯Î± Î‘Î¹Ï„Î¯Î±Ï‚:*\n"${text}"`;
            fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ chat_id: CHAT_ID, text: msg, parse_mode: 'Markdown' })
            })
            .then(res => res.json())
            .then(data => {
                if(data.ok) {
                    sendTelegramNotification("âœ… ÎÎµÎºÎ¯Î½Î·ÏƒÎµ Ï„Î·Î½ Î¤Î¹Î¼Ï‰ÏÎ¯Î± (Î›ÏŒÎ³Î¿Ï‚ ÎµÏƒÏ„Î¬Î»Î·)");
                    document.getElementById('reasonModal').style.display = 'none';
                    document.getElementById('infoPreQuiz').style.display = 'flex';
                } else {
                    alert("Error: " + data.description);
                    btn.innerText = "Î”Î¿ÎºÎ¯Î¼Î±ÏƒÎµ Î¾Î±Î½Î¬"; btn.disabled = false;
                }
            }).catch(e => { alert("Network Error"); btn.disabled = false; });
        }

        function startPunishQuiz() {
            document.getElementById('infoPreQuiz').style.display = 'none';
            document.getElementById('punishQuizModal').style.display = 'flex';
            showPunishQuestion();
        }

        const punishQuestions = [
            { q: "Î Î¿Î¹Î± ÎµÎ¯Î½Î±Î¹ Î· ÏƒÎ·Î¼Î±Î½Ï„Î¹ÎºÏŒÏ„ÎµÏÎ· Î±ÏÎµÏ„Î®;", a: ["Î¥Ï€Î¿Î¼Î¿Î½Î®", "Shopping"], c:0 },
            { q: "Î Î¿Î¹Î¿Ï‚ Î­Ï‡ÎµÎ¹ Ï€Î¬Î½Ï„Î± Î´Î¯ÎºÎ¹Î¿;", a: ["Î•Î³Ï", "Î•ÏƒÏ"], c:1 },
            { q: "Î¤Î¹ Î¸Î± ÎºÎ¬Î½ÎµÎ¹Ï‚ Ï†Î­Ï„Î¿Ï‚;", a: ["Î˜Î± ÎµÎ¯Î¼Î±Î¹ ÎºÎ±Î»Î®", "Î£ÎºÎ±Î½Ï„Î±Î»Î¹Î­Ï‚"], c:0 },
            { q: "Î‘Î¾Î¯Î¶ÎµÎ¹Ï‚ Î´ÏÏÎ±;", a: ["ÎÎ±Î¹!", "Î˜Î± Ï€ÏÎ¿ÏƒÏ€Î±Î¸Î®ÏƒÏ‰"], c:1 },
            { q: "Î ÏÏ‚ Î¶Î·Ï„Î¬Î¼Îµ ÏƒÏ…Î³Î³Î½ÏÎ¼Î·;", a: ["ÎœÎµ Î»ÏŒÎ³Î¹Î±", "ÎœÎµ Ï€ÏÎ¬Î¾ÎµÎ¹Ï‚"], c:1 }
        ];
        let pIdx = 0;

        function showPunishQuestion() {
            if(pIdx >= punishQuestions.length) {
                document.getElementById('punishQuizModal').style.display = 'none';
                sendTelegramNotification("ğŸ“ ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎµ Ï„Î¿ Quiz Î¤Î¹Î¼Ï‰ÏÎ¯Î±Ï‚ (ÎŒÎ»ÎµÏ‚ Î¿Î¹ Î±Ï€Î±Î½Ï„Î®ÏƒÎµÎ¹Ï‚ ÏƒÏ‰ÏƒÏ„Î­Ï‚).");
                document.getElementById('infoPreTyping').style.display = 'flex'; 
                return;
            }
            const q = punishQuestions[pIdx];
            document.getElementById('punishQuestion').innerText = q.q;
            const opts = document.getElementById('punishOptions');
            opts.innerHTML = '';
            q.a.forEach((ans, i) => {
                const btn = document.createElement('button');
                btn.className = 'btn quiz-btn';
                btn.innerText = ans;
                btn.onclick = () => {
                    if(i === q.c) { 
                        pIdx++; showPunishQuestion(); 
                    } else { 
                        alert("Î›Î‘Î˜ÎŸÎ£! ÎÎ±Î½Î±Ï€ÏÎ¿ÏƒÏ€Î¬Î¸Î·ÏƒÎµ."); 
                    }
                };
                opts.appendChild(btn);
            });
        }

        // --- STAGE 2: TYPING GAME ---
        let typingScore = 0;
        let typingInterval;
        const TARGET_PHRASE = "Î˜Î± ÎµÎ¯Î¼Î±Î¹ Ï†ÏÏŒÎ½Î¹Î¼Î· ÎºÎ±Î¹ Ï…Ï€Î¬ÎºÎ¿Ï…Î·";

        function startTyping() {
            document.getElementById('infoPreTyping').style.display = 'none';
            document.getElementById('typingModal').style.display = 'flex';
            typingScore = 0;
            updateTypingUI();
            if(typingInterval) clearInterval(typingInterval);
            typingInterval = setInterval(decayTyping, 1000); 
        }

        function submitTyping() {
            const input = document.getElementById('typingInput');
            const error = document.getElementById('typingError');
            
            if(input.value.trim() === TARGET_PHRASE) {
                typingScore += 25; 
                input.value = "";
                error.innerText = "";
                if(typingScore >= 100) {
                    typingScore = 100;
                    finishTyping();
                }
            } else {
                error.innerText = "Î›Î‘Î˜ÎŸÎ£! Î ÏÏŒÏƒÎµÏ‡Îµ Ï„Î¿Ï…Ï‚ Ï„ÏŒÎ½Î¿Ï…Ï‚!";
            }
            updateTypingUI();
        }

        function decayTyping() {
            if(typingScore > 0) {
                typingScore -= 1; 
                updateTypingUI();
            }
        }

        function updateTypingUI() {
            document.getElementById('typingBar').style.width = typingScore + "%";
        }

        function finishTyping() {
            clearInterval(typingInterval);
            sendTelegramNotification("âœ… ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎµ Ï„Î·Î½ Î Î»Î·ÎºÏ„ÏÎ¿Î»ÏŒÎ³Î·ÏƒÎ·.");
            setTimeout(() => {
                document.getElementById('typingModal').style.display = 'none';
                document.getElementById('infoPrePose').style.display = 'flex';
            }, 500);
        }

        // --- STAGE 3: POSE ---
        function startPose() {
            document.getElementById('infoPrePose').style.display = 'none';
            document.getElementById('poseModal').style.display = 'flex';
        }

        function finishPose() {
            document.getElementById('poseModal').style.display = 'none';
            document.getElementById('infoPreNose').style.display = 'flex';
        }

        // --- IMAGE UPLOADER ---
        function compressAndUpload(inputId, caption, successCallback) {
            const input = document.getElementById(inputId);
            const statusId = inputId === 'photoInput' ? 'photoStatus' : 'poseStatus';
            const status = document.getElementById(statusId);
            const btn = document.querySelector(`#${inputId}`).nextElementSibling;

            if(input.files.length === 0) { alert("Î’Î³Î¬Î»Îµ Ï†ÏÏ„Î¿!"); return; }

            const originalBtnText = btn.innerText;
            btn.innerText = "Î£Ï…Î¼Ï€Î¯ÎµÏƒÎ·..."; btn.disabled = true;
            status.innerText = "Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± ÎµÎ¹ÎºÏŒÎ½Î±Ï‚...";

            const file = input.files[0];
            const reader = new FileReader();
            reader.readAsDataURL(file);
            
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 800; 
                    const scaleSize = MAX_WIDTH / img.width;
                    canvas.width = MAX_WIDTH;
                    canvas.height = img.height * scaleSize;

                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                    canvas.toBlob((blob) => {
                        btn.innerText = "Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î®...";
                        status.innerText = "Î‘Î½Î­Î²Î±ÏƒÎ¼Î±...";
                        
                        const formData = new FormData();
                        formData.append('chat_id', CHAT_ID);
                        formData.append('photo', blob, 'image.jpg');
                        formData.append('caption', caption);

                        fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`, {
                            method: 'POST',
                            body: formData
                        })
                        .then(res => res.json())
                        .then(data => {
                            if(data.ok) {
                                status.innerText = "Î•ÏƒÏ„Î¬Î»Î·! âœ…";
                                setTimeout(successCallback, 1000);
                            } else {
                                alert("Telegram Error: " + data.description);
                                btn.innerText = originalBtnText; btn.disabled = false;
                            }
                        })
                        .catch(err => {
                            alert("Upload Error");
                            btn.innerText = originalBtnText; btn.disabled = false;
                        });
                    }, 'image/jpeg', 0.7);
                }
            }
        }

        // --- STAGE 4: NOSE CHALLENGE ---
        let noseStream = null;
        let noseRecorder = null;
        let noseChunks = [];
        let noseTimer = 30.0;
        let noseInterval;
        let noseActive = false;
        let audioContext, analyser, microphone, dataArray;
        let silenceCounter = 0;

        function initNoseStage() {
            document.getElementById('infoPreNose').style.display = 'none';
            document.getElementById('noseModal').style.display = 'flex';
            
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: true })
            .then(stream => {
                noseStream = stream;
                document.getElementById('noseVideo').srcObject = stream;
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);
                microphone.connect(analyser);
                analyser.fftSize = 256;
                dataArray = new Uint8Array(analyser.frequencyBinCount);
            })
            .catch(err => alert("Need Camera & Mic!"));
        }

        function startNoseHold(e) {
            if(e && e.type === 'touchstart') e.preventDefault();
            if(noseActive) return;
            
            noseActive = true;
            noseTimer = 30.0;
            silenceCounter = 0;
            
            document.getElementById('noseBtn').style.transform = "scale(0.9)";
            document.getElementById('noseBtn').style.background = "radial-gradient(circle, #009900, #005500)";
            document.getElementById('noseMsg').innerText = "ÎœÎ™Î›Î‘! 'Î‰Î¼Î¿Ï…Î½ Î¬Ï„Î±ÎºÏ„Î·...'";

            noseChunks = [];
            noseRecorder = new MediaRecorder(noseStream);
            noseRecorder.addEventListener("dataavailable", e => noseChunks.push(e.data));
            noseRecorder.start();

            if(noseInterval) clearInterval(noseInterval);
            noseInterval = setInterval(() => {
                noseTimer -= 0.1;
                document.getElementById('noseTimer').innerText = noseTimer.toFixed(1);
                
                analyser.getByteFrequencyData(dataArray);
                let sum = 0;
                for(let i=0; i<dataArray.length; i++) sum += dataArray[i];
                let average = sum / dataArray.length;
                
                const ind = document.getElementById('voiceIndicator');
                if(average > 10) ind.style.background = "#00ff00";
                else ind.style.background = "#333";

                if(average < 10) {
                    silenceCounter++;
                    if(silenceCounter > 15) failNose("Î”Î•Î Î£Î• Î‘ÎšÎŸÎ¥Î©! Î ÏÎ­Ï€ÎµÎ¹ Î½Î± Î¼Î¹Î»Î¬Ï‚!");
                } else {
                    silenceCounter = 0;
                }
                
                if(noseTimer <= 0) finishNoseSuccess();
            }, 100);
        }

        function endNoseHold(e) {
            if(e && e.type === 'touchend') e.preventDefault();
            if(!noseActive) return; 
            failNose("Î£Î®ÎºÏ‰ÏƒÎµÏ‚ Ï„Î· Î¼ÏÏ„Î·! ÎšÎ»Î­Î²ÎµÎ¹Ï‚!");
        }

        function failNose(msg) {
            noseActive = false;
            clearInterval(noseInterval);
            if(noseRecorder && noseRecorder.state === "recording") noseRecorder.stop();
            document.getElementById('noseBtn').style.transform = "scale(1)";
            document.getElementById('noseBtn').style.background = "radial-gradient(circle, #ff5555, #990000)";
            document.getElementById('noseMsg').innerText = "Î‘Ï€Î­Ï„Ï…Ï‡ÎµÏ‚!";
            document.getElementById('noseTimer').innerText = "FAIL";
            alert(msg + " ÎÎ±Î½Î¬ Î±Ï€ÏŒ Ï„Î·Î½ Î±ÏÏ‡Î®!");
            noseTimer = 30.0;
            document.getElementById('noseTimer').innerText = "30.0";
        }

        function finishNoseSuccess() {
            noseActive = false;
            clearInterval(noseInterval);
            noseRecorder.stop();
            document.getElementById('noseBtn').style.pointerEvents = "none";
            document.getElementById('noseMsg').innerText = "Î•Î Î™Î¤Î¥Î§Î™Î‘! Î‘Î½Î­Î²Î±ÏƒÎ¼Î±...";
            
            noseRecorder.addEventListener("stop", () => {
                const blob = new Blob(noseChunks, { type: 'video/webm' });
                const formData = new FormData();
                formData.append('chat_id', CHAT_ID);
                formData.append('video', blob);
                formData.append('caption', 'ğŸ‘ƒ Î”Î¿ÎºÎ¹Î¼Î±ÏƒÎ¯Î± ÎœÏÏ„Î·Ï‚ + Î‰Ï‡Î¿Ï‚ (Video)');
                
                fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendVideo`, { method: 'POST', body: formData })
                .then(res => res.json())
                .then(data => {
                    if(noseStream) noseStream.getTracks().forEach(track => track.stop());
                    setTimeout(() => {
                        document.getElementById('noseModal').style.display = 'none';
                        document.getElementById('infoPreWrite').style.display = 'flex';
                    }, 1000);
                })
                .catch(err => alert("Video Upload Error"));
            });
        }

        // --- STAGE 5: HANDWRITING ---
        function startHandwriting() {
            document.getElementById('infoPreWrite').style.display = 'none';
            document.getElementById('handwritingModal').style.display = 'flex';
        }

        function finishHandwriting() {
            document.getElementById('handwritingModal').style.display = 'none';
            document.getElementById('infoPreCorner').style.display = 'flex';
        }

        // --- CORNER ---
        let cornerTime = 0;
        let cornerInterval;
        let servedExtra = false;

        function startCorner(seconds) {
            document.getElementById('infoPreCorner').style.display = 'none';
            document.getElementById('extraTimeModal').style.display = 'none'; 
            document.getElementById('cornerUI').style.display = 'flex';
            cornerTime = seconds; updateTimer();
            document.addEventListener('visibilitychange', handleVisibilityChange);
            document.getElementById('cornerUI').addEventListener('click', handleBadClick);
            cornerInterval = setInterval(() => {
                cornerTime--; updateTimer();
                if(cornerTime <= 0) {
                    clearInterval(cornerInterval);
                    document.getElementById('endCornerBtn').style.display = 'block';
                    document.getElementById('timerDisplay').style.color = '#00ff00';
                }
            }, 1000);
        }

        function updateTimer() {
            const m = Math.floor(cornerTime / 60).toString().padStart(2, '0');
            const s = (cornerTime % 60).toString().padStart(2, '0');
            document.getElementById('timerDisplay').innerText = `${m}:${s}`;
        }

        function handleVisibilityChange() {
            if(document.hidden && document.getElementById('cornerUI').style.display === 'flex') {
                cornerTime += 10;
                const t = document.getElementById('timerDisplay');
                t.style.color = 'red';
                setTimeout(() => t.style.color = 'var(--accent-red)', 1000);
            }
        }

        function handleBadClick(e) {
            if(e.target.id === 'cornerUI') {
                cornerTime += 10;
                const t = document.getElementById('timerDisplay');
                t.style.color = 'red';
                setTimeout(() => t.style.color = 'var(--accent-red)', 200);
            }
        }

        function pokeCorner() { /* Dummy */ }

        function finishCorner() {
            document.removeEventListener('visibilitychange', handleVisibilityChange);
            document.getElementById('cornerUI').removeEventListener('click', handleBadClick);
            clearInterval(cornerInterval);
            sendTelegramNotification("âœ… ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎµ Ï„Î· Î“Ï‰Î½Î¯Î±.");
            document.getElementById('cornerUI').style.display = 'none';
            document.getElementById('apologyModal').style.display = 'flex';
        }

        // --- APOLOGY ---
        let apolRecorder;
        let apolChunks = [];

        async function startApologyRec() {
            try {
                const s = await navigator.mediaDevices.getUserMedia({ audio: true });
                apolRecorder = new MediaRecorder(s);
                apolChunks = [];
                apolRecorder.addEventListener("dataavailable", e => apolChunks.push(e.data));
                apolRecorder.start();
                document.getElementById('apologyRecBtn').style.background = 'red';
            } catch(e) { alert("Mic Error"); }
        }

        function stopApologyRec() {
            if(!apolRecorder) return;
            apolRecorder.stop();
            document.getElementById('apologyRecBtn').style.background = 'white';
            
            apolRecorder.addEventListener("stop", () => {
                const blob = new Blob(apolChunks, { type: 'audio/ogg' });
                document.getElementById('analysisUI').style.display = 'block';
                document.getElementById('apologyBar').style.width = '100%';
                const cap = servedExtra ? "Î¤ÎµÎ»Î¹ÎºÎ® Î£Ï…Î³Î³Î½ÏÎ¼Î· (Approved)" : "Î ÏÏÏ„Î· Î£Ï…Î³Î³Î½ÏÎ¼Î· (Rejected)";
                sendVoice(blob, cap, () => {
                    setTimeout(handleApologyResult, 2000);
                });
            });
        }

        function sendVoice(blob, caption, callback) {
            const formData = new FormData();
            formData.append('chat_id', CHAT_ID);
            formData.append('voice', blob);
            formData.append('caption', caption);
            fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendVoice`, { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => {
                if(data.ok) callback();
                else alert("Telegram Error: " + data.description);
            });
        }

        function handleApologyResult() {
            document.getElementById('apologyModal').style.display = 'none';
            document.getElementById('analysisUI').style.display = 'none';
            document.getElementById('apologyBar').style.width = '0%';
            if(!servedExtra) {
                document.getElementById('extraTimeModal').style.display = 'flex';
                servedExtra = true;
            } else {
                document.getElementById('successModal').style.display = 'flex';
            }
        }

        function startExtraCorner() {
            document.getElementById('endCornerBtn').style.display = 'none';
            document.getElementById('timerDisplay').style.color = 'var(--accent-red)';
            startCorner(2); 
        }

        function finishPunishment() {
            window.location.href = 'index.html?evaluated=true';
        }
    </script>
</body>
</html>
