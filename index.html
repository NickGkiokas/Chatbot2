<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mpompos Christmas Store ğŸ„</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #c0392b; /* Christmas Red */
            --secondary: #27ae60; /* Christmas Green */
            --gold: #f1c40f;
            --dark: #2c3e50;
            --light: #ecf0f1;
            --sidebar-width: 250px;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background-color: #f5f7fa; color: var(--dark); overflow-x: hidden; }

        /* --- LOADERS --- */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--primary); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; transition: opacity 0.5s;
        }
        .loader-icon { font-size: 5rem; animation: bounce 2s infinite; }
        .loader-text { font-size: 2rem; font-weight: bold; margin-top: 20px; letter-spacing: 2px; }

        #processing-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); z-index: 4000;
            display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center;
        }
        .spinner { width: 50px; height: 50px; border: 5px solid #eee; border-top: 5px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }

        /* --- HEADER --- */
        header {
            background-color: white; height: 60px; display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1000;
        }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .hamburger { font-size: 1.4rem; cursor: pointer; color: var(--primary); transition: 0.2s; }
        .brand { font-size: 1.2rem; font-weight: 800; color: var(--primary); cursor: pointer; display: flex; align-items: center; gap: 8px; }
        
        .user-panel { display: flex; align-items: center; gap: 10px; }
        .balance-card { 
            background: var(--dark); color: var(--gold); padding: 4px 12px; border-radius: 20px; 
            font-weight: bold; font-size: 0.85rem; border: 1px solid var(--gold); 
            cursor: pointer; transition: transform 0.2s; display: flex; align-items: center; gap: 5px;
        }
        .balance-card:active { transform: scale(0.95); }
        .cart-icon { position: relative; cursor: pointer; font-size: 1.2rem; color: var(--dark); padding: 5px; }
        .cart-badge { position: absolute; top: -5px; right: -8px; background: var(--primary); color: white; border-radius: 50%; width: 16px; height: 16px; font-size: 0.65rem; display: flex; justify-content: center; align-items: center; }

        /* --- NAV --- */
        .nav-sidebar {
            position: fixed; top: 0; left: -300px; width: 260px; height: 100%; background: white; 
            box-shadow: 5px 0 15px rgba(0,0,0,0.1); z-index: 2000; transition: 0.3s ease-in-out;
            display: flex; flex-direction: column;
        }
        .nav-sidebar.open { left: 0; }
        .nav-header { padding: 20px; background: var(--primary); color: white; display: flex; justify-content: space-between; align-items: center; }
        .nav-content { padding: 10px; overflow-y: auto; flex: 1; }
        .menu-group { margin-bottom: 5px; }
        .menu-title { padding: 12px 15px; background: #f8f9fa; cursor: pointer; font-weight: bold; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .menu-items { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; padding-left: 10px; }
        .menu-items.open { max-height: 500px; }
        .nav-item { display: flex; align-items: center; padding: 10px 15px; cursor: pointer; color: #555; border-radius: 8px; margin: 5px 0; transition: 0.2s; }
        .nav-item:hover { background: #f0f2f5; color: var(--primary); }
        .nav-item i { width: 25px; text-align: center; margin-right: 10px; }

        /* --- CONTENT --- */
        .content { max-width: 1200px; margin: 0 auto; padding: 15px; width: 100%; box-sizing: border-box; }
        .hero { background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%); border-radius: 15px; padding: 20px; color: white; margin-bottom: 20px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.1); position: relative; overflow: hidden; }
        .hero h1 { margin: 0 0 5px 0; font-size: 1.5rem; }
        
        /* FILTERS BAR */
        .filter-bar {
            background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin-bottom: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;
        }
        .filter-group { display: flex; flex-direction: column; gap: 5px; flex: 1; min-width: 120px; }
        .filter-label { font-size: 0.8rem; font-weight: bold; color: #777; }
        .filter-select { padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 0.9rem; outline: none; }
        .filter-range { width: 100%; accent-color: var(--primary); cursor: pointer; }

        /* GRID & CARDS - MOBILE OPTIMIZED */
        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); /* Smaller min-width for mobile */
            gap: 15px; 
        }

        /* Î•Ï†Î­ Ï€Î±Ï„Î®Î¼Î±Ï„Î¿Ï‚ */
        .btn:active {
            transform: scale(0.95);
        }
        
        /* ÎšÎ»Î¬ÏƒÎ· Î³Î¹Î± Ï„Î¿ ÎµÏ†Î­ ÎµÏ€Î¹Ï„Ï…Ï‡Î¯Î±Ï‚ */
        .btn-added {
            background-color: var(--secondary) !important; /* Î“Î¯Î½ÎµÏ„Î±Î¹ Ï€ÏÎ¬ÏƒÎ¹Î½Î¿ */
            color: white !important;
            transition: all 0.2s ease;
            transform: scale(1.05); /* ÎœÎµÎ³Î±Î»ÏÎ½ÎµÎ¹ ÎµÎ»Î¬Ï‡Î¹ÏƒÏ„Î± */
            box-shadow: 0 0 10px rgba(39, 174, 96, 0.5); /* Î›Î¬Î¼ÏˆÎ· */
        }
        
        .card { 
            background: white; 
            border-radius: 12px; 
            padding: 15px; 
            text-align: center; 
            border: 1px solid #eee; 
            transition: 0.3s; 
            position: relative; 
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100%; 
            min-height: 250px; /* Reduced min-height */
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }
        
        .card:hover { transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.08); border-color: var(--primary); }
        
        .card-icon { 
            font-size: 3.5rem; /* Adjusted size */
            margin-bottom: 10px; 
            display: block; 
            filter: drop-shadow(0 2px 3px rgba(0,0,0,0.1)); 
            line-height: 1; 
        }
        
        .card-content-wrapper {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .card-title { font-weight: 700; margin-bottom: 5px; font-size: 1rem; line-height: 1.2; }
        .card-desc { font-size: 0.8rem; color: #777; margin-bottom: 10px; flex-grow: 1; line-height: 1.3; }
        
        .price-tag { 
            display: inline-block; 
            padding: 4px 10px; 
            border-radius: 15px; 
            font-weight: bold; 
            font-size: 0.85rem; 
            margin-bottom: 10px; 
            width: fit-content;
        }
        .price-neg { background: #fadbd8; color: var(--primary); }
        .price-pos { background: #d5f5e3; color: var(--secondary); }
        
        .btn { border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: 600; width: 100%; transition: 0.2s; box-sizing: border-box; font-size: 0.9rem; margin-top: auto;}
        .btn-buy { background: var(--dark); color: white; }
        .btn-buy:active { transform: scale(0.98); }
        .btn-earn { background: var(--secondary); color: white; }
        .btn.sold-out { background: #dfe6e9 !important; color: #b2bec3 !important; cursor: not-allowed !important; pointer-events: none; border: 1px solid #ccc; }

        /* Mobile specific adjustments */
        @media (max-width: 480px) {
            .grid {
                grid-template-columns: repeat(2, 1fr); /* Force 2 columns */
                gap: 10px;
            }
            .card {
                padding: 10px;
                min-height: 220px;
            }
            .card-icon {
                font-size: 3rem;
            }
            .card-title {
                font-size: 0.95rem;
            }
            .btn {
                padding: 8px;
                font-size: 0.85rem;
            }
        }

        /* Extra & Cart */
        .extra-container { background: white; padding: 20px; border-radius: 15px; max-width: 600px; margin: 0 auto; text-align: center; border: 1px solid #eee; }
        textarea { width: 100%; padding: 15px; border: 2px solid #eee; border-radius: 10px; margin: 20px 0; font-family: inherit; resize: vertical; min-height: 100px; box-sizing: border-box; }
        .cart-overlay { position: fixed; top: 0; right: -100%; width: 85%; max-width: 320px; height: 100%; background: white; box-shadow: -5px 0 15px rgba(0,0,0,0.1); z-index: 2000; transition: 0.3s; padding: 20px; display: flex; flex-direction: column; box-sizing: border-box; }
        .cart-overlay.open { right: 0; }
        .cart-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px; }
        .cart-items { flex: 1; overflow-y: auto; list-style: none; padding: 0; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px dashed #eee; font-size: 0.9rem; }
        .cart-footer { border-top: 2px solid #eee; padding-top: 15px; }
        .backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 1500; display: none; }
        .backdrop.active { display: block; }

        /* --- MODALS --- */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3000; display: none; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        .pay-card { background: white; width: 100%; max-width: 400px; padding: 25px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); animation: popIn 0.3s; box-sizing: border-box; position: relative; text-align: center; max-height: 90vh; overflow-y: auto; }
        @keyframes popIn { from {transform: scale(0.9); opacity: 0;} to {transform: scale(1); opacity: 1;} }
        
        .welcome-icon { font-size: 3rem; color: var(--primary); margin-bottom: 10px; }
        .form-group { margin-bottom: 15px; text-align: left; }
        .form-label { display: block; font-size: 0.9rem; margin-bottom: 5px; font-weight: 600; }
        .form-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
        .row { display: flex; gap: 10px; }

        .status-row { display: flex; justify-content: space-between; align-items: center; background: #f9f9f9; padding: 15px; border-radius: 8px; margin-top: 20px; }
        .status-light { width: 15px; height: 15px; background-color: #e74c3c; border-radius: 50%; box-shadow: 0 0 10px rgba(231, 76, 60, 0.8); display: inline-block; }
        .info-row { display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px;}

        .receipt { background: #fffdf0; padding: 25px; width: 100%; max-width: 350px; font-family: 'Courier New', monospace; box-shadow: 0 5px 15px rgba(0,0,0,0.2); max-height: 80vh; overflow-y: auto; text-align: left;}
        details.receipt-details { width: 100%; border-bottom: 1px dotted #ccc; margin-bottom: 5px; padding-bottom: 5px; }
        details.receipt-details summary { cursor: pointer; list-style: none; display: flex; justify-content: space-between; align-items: center; }
        details.receipt-details summary::after { content: 'â–¼'; font-size: 0.8em; color: #555; }
        details.receipt-details[open] summary::after { content: 'â–²'; }
        .receipt-full-text { font-size: 0.8em; background: rgba(0,0,0,0.05); padding: 8px; margin-top: 5px; border-radius: 4px; font-style: italic; word-wrap: break-word; }

        /* OVERVIEW LIST STYLES */
        .overview-list { list-style: none; padding: 0; text-align: left; margin: 15px 0; }
        .overview-list li { border-bottom: 1px solid #eee; padding: 8px 0; display: flex; justify-content: space-between; font-size: 0.9rem; }
        .overview-header { background: #f0f2f5; padding: 10px; font-weight: bold; border-radius: 5px; margin-top: 15px; text-align: left; color: var(--dark); }
        .important-note { background: #fff3cd; color: #856404; padding: 15px; border-radius: 8px; font-size: 0.85rem; text-align: left; margin-top: 20px; border: 1px solid #ffeeba; }

        /* FIXED OPTION BUTTONS */
        .opt-btn-wrapper { margin-bottom: 10px; width: 100%; }
        .opt-btn { display: flex; justify-content: space-between; align-items: center; width: 100%; padding: 15px; border: 1px solid #e0e0e0; border-radius: 10px; background: #fff; cursor: pointer; transition: all 0.2s ease; text-align: left; box-sizing: border-box; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .opt-btn:hover { border-color: var(--primary); background: #fff5f5; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .opt-btn span { font-weight: 600; color: #333; font-size: 1rem; }
        .opt-btn b { color: var(--primary); white-space: nowrap; margin-left: 10px; font-size: 1.1rem; }
        .opt-btn.disabled { opacity: 0.6; cursor: not-allowed; background: #f0f0f0; border-color: #ddd; box-shadow: none; transform: none; }
        .opt-btn.disabled b { color: #888; }

    </style>
</head>
<body>

    <div id="loader">
        <div class="loader-icon">ğŸ…ğŸ»</div>
        <div class="loader-text">CHRISTMAS SHOP LOADING...</div>
        <div style="margin-top:10px; font-size:0.9rem; opacity:0.8;">Î•Ï„Î¿Î¹Î¼Î¬Î¶Î¿Î½Ï„Î±Î¹ Ï„Î± Î¾Ï‰Ï„Î¹ÎºÎ¬...</div>
    </div>

    <div id="processing-overlay">
        <div class="spinner"></div>
        <h2 style="margin-top:20px; color:var(--dark);">Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± Î£Ï…Î½Î±Î»Î»Î±Î³Î®Ï‚...</h2>
        <p style="color:#777;">Î•Ï€Î¹ÎºÎ¿Î¹Î½Ï‰Î½Î¯Î± Î¼Îµ Ï„Î·Î½ Î¤ÏÎ¬Ï€ÎµÎ¶Î± ÎœÏ€ÏŒÎ¼Ï€Ï‰Î½...</p>
    </div>

    <div class="backdrop" id="backdrop" onclick="closeAllSidebars()"></div>

    <header>
        <div class="header-left">
            <i class="fas fa-bars hamburger" onclick="toggleNav()"></i>
            <div class="brand" onclick="renderHome()">
                <i class="fas fa-snowflake"></i> Mpompos Shop
            </div>
        </div>
        <div class="user-panel">
            <div class="balance-card" onclick="openProfile()">
                <i class="fas fa-wallet"></i>
                <span id="balance-display">0</span> pts
            </div>
            <div class="cart-icon" onclick="toggleCart()">
                <i class="fas fa-shopping-cart"></i>
                <span class="cart-badge" id="cart-count">0</span>
            </div>
        </div>
    </header>

    <div class="nav-sidebar" id="nav-sidebar">
        <div class="nav-header">
            <span style="font-weight:bold; font-size:1.2rem;">ÎœÎµÎ½Î¿Ï</span>
            <i class="fas fa-times" style="cursor:pointer;" onclick="toggleNav()"></i>
        </div>
        <div class="nav-content">
            <div class="nav-item" onclick="renderHome(); toggleNav();"><i class="fas fa-home"></i> Î‘ÏÏ‡Î¹ÎºÎ®</div>
            <div class="menu-group">
                <div class="menu-title" onclick="toggleSubMenu('menu-purchases')">
                    <span>ğŸ›’ Î‘Î³Î¿ÏÎ­Ï‚ & Î‘Î¹Ï„Î®Î¼Î±Ï„Î±</span> <i class="fas fa-chevron-down arrow"></i>
                </div>
                <div class="menu-items" id="menu-purchases">
                    <div class="nav-item" onclick="filterCategory('gifts', 'Î”ÏÏÎ±'); toggleNav();"><i class="fas fa-gift"></i> Î”ÏÏÎ±</div>
                    <div class="nav-item" onclick="filterCategory('requests', 'Î†Î´ÎµÎ¹ÎµÏ‚'); toggleNav();"><i class="fas fa-pray"></i> Î†Î´ÎµÎ¹ÎµÏ‚</div>
                    <div class="nav-item" onclick="filterCategory('extra', 'Custom'); toggleNav();"><i class="fas fa-magic"></i> Î“ÏÎ±Ï€Ï„Î¬ Î‘Î¹Ï„Î®Î¼Î±Ï„Î±</div>
                </div>
            </div>
            <div class="menu-group">
                <div class="menu-title" onclick="toggleSubMenu('menu-obligations')">
                    <span>ğŸ“œ Î¥Ï€Î¿Ï‡ÏÎµÏÏƒÎµÎ¹Ï‚</span> <i class="fas fa-chevron-down arrow"></i>
                </div>
                <div class="menu-items" id="menu-obligations">
                    <div class="nav-item" onclick="filterCategory('rules', 'ÎšÎ±Î½ÏŒÎ½ÎµÏ‚'); toggleNav();"><i class="fas fa-clipboard-check"></i> ÎšÎ±Î½ÏŒÎ½ÎµÏ‚ & Î”ÎµÏƒÎ¼ÎµÏÏƒÎµÎ¹Ï‚</div>
                </div>
            </div>
        </div>
    </div>

    <main class="content" id="main-content"></main>

    <div class="cart-overlay" id="cart-sidebar">
        <div class="cart-header">
            <h3>ğŸ›’ ÎšÎ±Î»Î¬Î¸Î¹</h3>
            <i class="fas fa-times" style="cursor:pointer" onclick="toggleCart()"></i>
        </div>
        <ul class="cart-items" id="cart-list-items">
            <li style="text-align:center; color:#999; margin-top:20px;">Î†Î´ÎµÎ¹Î¿...</li>
        </ul>
        <div class="cart-footer">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; font-weight:bold;">
                <span>Î£ÏÎ½Î¿Î»Î¿:</span> <span id="cart-total-display">0 pts</span>
            </div>
            <button class="btn btn-buy" onclick="openPayment()">Î¤Î±Î¼ÎµÎ¯Î¿</button>
        </div>
    </div>

    <div class="modal" id="welcome-modal">
        <div class="pay-card">
            <div class="welcome-icon">ğŸ„</div>
            <h2>ÎšÎ±Î»ÏÏ‚ Î®ÏÎ¸ÎµÏ‚!</h2>
            <p>ÎšÎ±Î»Ï‰ÏƒÏŒÏÎ¹ÏƒÎµÏ‚ ÏƒÏ„Î¿ <strong>Mpompos Christmas Store</strong>!</p>
            <p style="color:#666;">Î•Î´Ï Î¸Î± Î²ÏÎµÎ¹Ï‚ ÏŒÎ»Î± ÏŒÏƒÎ± Î¸Î­Î»ÎµÎ¹Ï‚ (ÎºÎ±Î¹ ÏŒÏƒÎ± Ï€ÏÎ­Ï€ÎµÎ¹) Î½Î± ÎºÎ¬Î½ÎµÎ¹Ï‚, Î³Î¹Î± Ï„Î¿ Î´Î¹Î¬ÏƒÏ„Î·Î¼Î± 25-30/12 Ï€Î¿Ï… Î¸Î± ÎµÎ¯ÏƒÎ±Î¹ Î¼ÏŒÎ½Î· ÏƒÎ¿Ï…. Î ÎµÏÎ¹Î·Î³Î®ÏƒÎ¿Ï… ÎµÎ»ÎµÏÎ¸ÎµÏÎ±, Î´ÏÏƒÎµ Ï€ÏÎ¿ÏƒÎ¿Ï‡Î® ÎºÎ±Î¹ ÎºÎ±Î»Î¬ ÏˆÏÎ½Î¹Î±!</p>
            <button class="btn btn-buy" onclick="closeWelcome()">Î•Ï€ÏŒÎ¼ÎµÎ½Î¿</button>
        </div>
    </div>

    <div class="modal" id="coupon-hint-modal">
        <div class="pay-card">
            <div class="welcome-icon">ğŸ’¡</div>
            <h2>ÎœÎ·Î½ Î¾ÎµÏ‡Î¬ÏƒÎµÎ¹Ï‚!</h2>
            <p>Î Î¬Ï„Î± ÏƒÏ„Î¿ <strong>Ï€Î¿ÏÏ„Î¿Ï†ÏŒÎ»Î¹</strong> (Ï€Î¬Î½Ï‰ Î´ÎµÎ¾Î¹Î¬ Î´Î¯Ï€Î»Î± ÏƒÏ„Î¿ ÎºÎ±Î»Î¬Î¸Î¹ Î±Î³Î¿ÏÏÎ½) Î³Î¹Î± Î½Î± Î²Î¬Î»ÎµÎ¹Ï‚ Ï„Î¿ ÎºÎ¿Ï…Ï€ÏŒÎ½Î¹ ÏƒÎ¿Ï… ÎºÎ±Î¹ Î½Î± Î»Î¬Î²ÎµÎ¹Ï‚ 50 Ï€ÏŒÎ½Ï„Î¿Ï…Ï‚ Î´ÏÏÎ¿!</p>
            <button class="btn btn-buy" onclick="closeCouponHint()">ÎšÎ±Ï„Î¬Î»Î±Î²Î±!</button>
        </div>
    </div>

    <div class="modal" id="coupon-modal">
        <div class="pay-card">
            <div class="welcome-icon">ğŸŸï¸</div>
            <h2>Bonus Î•Î³Î³ÏÎ±Ï†Î®Ï‚</h2>
            <p>ÎŸÎ¹ Ï€ÏŒÎ½Ï„Î¿Î¹ ÏƒÎ¿Ï… ÎµÎ¯Î½Î±Î¹ 0. Î’Î¬Î»Îµ Ï„Î¿Î½ ÎºÏ‰Î´Î¹ÎºÏŒ Ï„Î¿Ï… ÎºÎ¿Ï…Ï€Î¿Î½Î¹Î¿Ï Ï€Î¿Ï… Î­Ï‡ÎµÎ¹Ï‚ Î»Î¬Î²ÎµÎ¹ Î³Î¹Î± Î½Î± Î¾ÎµÎºÎ¹Î½Î®ÏƒÎµÎ¹Ï‚ Î¼Îµ 50 Ï€ÏŒÎ½Ï„Î¿Ï…Ï‚!</p>
            <input type="text" id="coupon-input" class="form-input" placeholder="ÎšÏ‰Î´Î¹ÎºÏŒÏ‚ ÎšÎ¿Ï…Ï€Î¿Î½Î¹Î¿Ï" style="text-align:center; text-transform:uppercase; margin-bottom:15px;">
            <button class="btn btn-earn" onclick="checkCoupon()">Î•Î¾Î±ÏÎ³ÏÏÏ‰ÏƒÎ·</button>
            <button class="btn" style="margin-top:10px; background:#ddd;" onclick="closeModal('coupon-modal')">Î‘ÎºÏÏÏ‰ÏƒÎ·</button>
        </div>
    </div>

    <div class="modal" id="profile-modal">
        <div class="pay-card">
            <h2 style="margin-top:0;">ğŸ‘©ğŸ» Î•Ï€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ·</h2>
            <div style="text-align:left; margin-top:20px;">
                <div class="info-row"><span style="color:#666;">ÎŒÎ½Î¿Î¼Î±:</span><strong>ÎœÏ€ÏŒÎ¼Ï€Î¿Ï‚</strong></div>
                <div class="info-row"><span style="color:#666;">Î™Î´Î¹ÏŒÏ„Î·Ï„Î±:</span><strong>Î‘Î³Î¿ÏÎ¬ÏƒÏ„ÏÎ¹Î±</strong></div>
                <div class="info-row"><span style="color:#666;">Î¤ÏÎ­Ï‡Î¿Î½ Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿:</span><strong id="profile-balance">0 pts</strong></div>
                
                <div style="margin: 15px 0; text-align:center;">
                    <button class="btn btn-earn" onclick="openCouponModal()">ğŸŸï¸ Î•Î¹ÏƒÎ±Î³Ï‰Î³Î® ÎšÎ¿Ï…Ï€Î¿Î½Î¹Î¿Ï</button>
                </div>

                <div class="status-row">
                    <div><span style="font-weight:bold; display:block;">ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· Î¤Î¹Î¼Ï‰ÏÎ¯Î±Ï‚</span><small style="color:#888;">(Î‘Î½Î±Î½ÎµÏÎ½ÎµÏ„Î±Î¹ Î±Ï…Ï„ÏŒÎ¼Î±Ï„Î±)</small></div>
                    <div style="display:flex; align-items:center; gap:10px;"><span style="color:var(--dark); font-weight:bold;">Î‘Î½ÎµÎ½ÎµÏÎ³Î®</span><span class="status-light"></span></div>
                </div>
            </div>
            <button class="btn btn-buy" style="margin-top:20px;" onclick="closeModal('profile-modal')">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
        </div>
    </div>

    <div class="modal" id="payment-modal">
        <div class="pay-card">
            <h2 style="margin-top:0;"><i class="far fa-credit-card"></i> Î Î»Î·ÏÏ‰Î¼Î®</h2>
            <form onsubmit="processPayment(event)">
                <div class="form-group"><label class="form-label">ÎšÎ¬Ï„Î¿Ï‡Î¿Ï‚</label><input type="text" class="form-input" value="ÎœÏ€ÏŒÎ¼Ï€Î¿Ï‚" readonly style="background:#f9f9f9;"></div>
                <div class="form-group"><label class="form-label">Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ ÎšÎ¬ÏÏ„Î±Ï‚</label><input type="text" class="form-input" placeholder="XXXX-XXXX-XXXX-XXXX" required pattern=".{10,}"></div>
                <div class="row">
                    <div class="form-group" style="flex:1"><label class="form-label">HM/NIA</label><input type="text" class="form-input" placeholder="12/30"></div>
                    <div class="form-group" style="flex:1"><label class="form-label">CVC</label><input type="text" class="form-input" placeholder="123"></div>
                </div>
                <div class="form-group"><label class="form-label">PIN ÎšÎ¬ÏÏ„Î±Ï‚</label><input type="password" id="secret-pin" class="form-input" required></div>
                <button type="submit" class="btn btn-earn" style="margin-top:10px;">Î Î»Î·ÏÏ‰Î¼Î®</button>
                <button type="button" class="btn" style="margin-top:10px; background:#ddd;" onclick="closeModal('payment-modal')">Î‘ÎºÏÏÏ‰ÏƒÎ·</button>
            </form>
        </div>
    </div>

    <div class="modal" id="receipt-modal">
        <div class="receipt">
            <div style="text-align:center; border-bottom:2px dashed #333; padding-bottom:10px; margin-bottom:15px;">
                <h3>MPOMPOS STORE</h3>
                <small>Î‘Î ÎŸÎ”Î•Î™ÎÎ—</small>
            </div>
            <div id="receipt-content"></div>
            <div style="border-top:2px dashed #333; margin-top:15px; padding-top:10px; text-align:center;">
                <p>Î•Î“ÎšÎ¡Î™Î˜Î—ÎšÎ•</p>
                <button class="btn btn-buy" onclick="openOverview()">ÎœÎµÏ„Î¬Î²Î±ÏƒÎ· ÏƒÏ„Î·Î½ Î•Ï€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ·</button>
            </div>
        </div>
    </div>

    <div class="modal" id="overview-modal">
        <div class="pay-card">
            <div class="welcome-icon">ğŸ“</div>
            <h2 style="margin-top:0;">ÎŸÎ´Î·Î³Î¯ÎµÏ‚ & Î£Ï…Î¼Ï†Ï‰Î½Î¯Î±</h2>
            
            <div id="overview-content">
                </div>

            <div class="important-note">
                <strong>âš ï¸ Î Î¡ÎŸÎ£ÎŸÎ§Î—:</strong><br>
                ÎŸÎ¹ Ï€ÏŒÎ½Ï„Î¿Î¹ Ï€Î¿Ï… ÎºÎµÏÎ´Î¯Î¶ÎµÎ¹Ï‚ Î¸Î± Ï€ÏÎ¿ÏƒÏ„Î¯Î¸ÎµÎ½Ï„Î±Î¹ <u>ÏƒÏ„Î±Î´Î¹Î±ÎºÎ¬</u>, ÏŒÏƒÎ¿ Ï„Î·ÏÎµÎ¯Ï‚ Ï„Î· ÏƒÏ…Î¼Ï†Ï‰Î½Î¯Î±.<br><br>
                Î•Î¬Î½ Î´ÎµÎ½ Ï„Î·ÏÎ·Î¸Î¿ÏÎ½ ÏŒÎ»Î± ÏŒÏ€Ï‰Ï‚ Ï€ÏÎ­Ï€ÎµÎ¹, Î´ÎµÎ½ Ï€ÏÎ¿ÏƒÏ„Î¯Î¸ÎµÎ½Ï„Î±Î¹ Ï€ÏŒÎ½Ï„Î¿Î¹, Î¬ÏÎ± Ï„Î¿ Ï…Ï€ÏŒÎ»Î¿Î¹Ï€Î¿ Î¸Î± Î¼ÎµÎ¯Î½ÎµÎ¹ Î±ÏÎ½Î·Ï„Î¹ÎºÏŒ ÎºÎ±Î¹ Î¸Î± ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î·Î¸ÎµÎ¯ Î· <strong>Î¤Î¹Î¼Ï‰ÏÎ¯Î±</strong> (Ï€Î¿Ï… Î±Ï…Ï„Î® Ï„Î· ÏƒÏ„Î¹Î³Î¼Î® Î±Î½ Ï€Î±Ï„Î®ÏƒÎµÎ¹Ï‚ Ï€Î¬Î½Ï‰ ÏƒÏ„Î¿Ï…Ï‚ Ï€ÏŒÎ½Ï„Î¿Ï…Ï‚ ÏƒÎ¿Ï… Î³ÏÎ¬Ï†ÎµÎ¹ ÏŒÏ„Î¹ ÎµÎ¯Î½Î±Î¹ Î±Î½ÎµÎ½ÎµÏÎ³Î®).
            </div>

            <div style="margin-top:20px;">
                <p style="font-size:0.9rem; color:#555;">Î‘Ï†Î¿Ï Î´Î¹Î¬Î²Î±ÏƒÎµÏ‚ ÎºÎ±Î¹ ÎºÎ±Ï„Î±Î½ÏŒÎ·ÏƒÎµÏ‚ Ï„Î± Ï€Î±ÏÎ±Ï€Î¬Î½Ï‰, Ï€Î¬Ï„Î± Ï„Î¿ ÎºÎ¿Ï…Î¼Ï€Î¯ Î³Î¹Î± Î½Î± Ï€ÏÎ¿Ï‡Ï‰ÏÎ®ÏƒÎµÎ¹Ï‚:</p>
                <button class="btn btn-earn" onclick="goToFinal()">ÎœÎ¬Î»Î¹ÏƒÏ„Î±</button>
            </div>
        </div>
    </div>

    <div class="modal" id="options-modal">
        <div class="pay-card">
            <h3 id="opt-title" style="margin-top:0; margin-bottom: 20px;">Î•Ï€Î¹Î»Î¿Î³Î®</h3>
            <div id="opt-buttons" style="margin: 20px 0;"></div>
            <button class="btn" style="background:#eee;" onclick="closeModal('options-modal')">Î†ÎºÏ…ÏÎ¿</button>
        </div>
    </div>

    <script>
        const TG_BOT_TOKEN = "7932574102:AAFQvlNoBw2AWpRuHO7DWlBnRWyA1DhOGuE"; 
        const TG_CHAT_ID = "7336951445"; 

        const SECRET_CODE = "1234";
        const COUPON_CODE = "MPOMPOS123";
        let currentBalance = 0;
        let cart = [];
        let currentCategory = 'home';
        let currentFilters = { tag: 'all', maxPrice: 100 };

        const db = {
            gifts: [
                { id: 'g1', name: "ÎšÎ±ÏƒÎºÏŒÎ»", price: -25, icon: "ğŸ§£", desc: "Î–ÎµÏƒÏ„ÏŒ ÎºÎ±Î¹ Î¼Î±Î»Î±ÎºÏŒ", tag: 'clothes' },
                { id: 'g2', name: "Î£Î¿ÎºÎ¿Î»Î±Ï„Î¬ÎºÎ¹Î±", price: -15, icon: "ğŸ«", desc: "Î’ÎµÎ»Î³Î¹ÎºÎ® ÏƒÎ¿ÎºÎ¿Î»Î¬Ï„Î±", tag: 'food' },
                { id: 'g3', name: "ÎšÎ¬Î»Ï„ÏƒÎµÏ‚", price: -10, icon: "ğŸ§¦", desc: "Î§ÏÎ¹ÏƒÏ„Î¿Ï…Î³ÎµÎ½Î½Î¹Î¬Ï„Î¹ÎºÎµÏ‚", tag: 'clothes' },
                { id: 'g4', name: "Î•ÏƒÏÏÎ¿Ï…Ï‡Î±", price: -30, icon: "ğŸ‘™", desc: "ÎˆÎºÏ€Î»Î·Î¾Î·", tag: 'clothes' },
                { id: 'g5', name: "Î†ÏÏ‰Î¼Î±", price: -40, icon: "ğŸ§´", desc: "Î— Î¼Ï…ÏÏ‰Î´Î¹Î¬ Ï€Î¿Ï… Î±Î³Î±Ï€Î¬Ï‚", tag: 'beauty' }
            ],
            requests: [
                { 
                    id: 'r1', name: "1 ÎœÎ­ÏÎ± Î†Î´ÎµÎ¹Î±", price: -20, icon: "ğŸ“…", desc: "ÎœÎ­Î³Î¹ÏƒÏ„Î¿: 1 Ï†Î¿ÏÎ¬", tag: 'leave',
                    hasOptions: true,
                    options: [
                        { id: 'r1_s', name: "1 ÎœÎ­ÏÎ± (ÎœÎ¹ÎºÏÎ® - 02:00)", price: -20 },
                        { id: 'r1_b', name: "1 ÎœÎ­ÏÎ± (ÎœÎµÎ³Î¬Î»Î· - 05:00)", price: -40 }
                    ]
                },
                { 
                    id: 'r2', name: "2 ÎœÎ­ÏÎµÏ‚ Î†Î´ÎµÎ¹Î±", price: -50, icon: "ğŸ“†", desc: "ÎœÎ­Î³Î¹ÏƒÏ„Î¿: 2 Ï†Î¿ÏÎ­Ï‚", tag: 'leave',
                    hasOptions: true,
                    options: [
                        { id: 'r2_s', name: "2 ÎœÎ­ÏÎµÏ‚ (ÎœÎ¹ÎºÏÎ­Ï‚ - 02:00)", price: -50 },
                        { id: 'r2_b', name: "2 ÎœÎ­ÏÎµÏ‚ (ÎœÎµÎ³Î¬Î»ÎµÏ‚ - 05:00)", price: -80 }
                    ]
                },
                { id: 'r3', name: "Gaming Night", price: -30, icon: "ğŸ®", desc: "ÎœÎ·Î½ ÎµÎ½Î¿Ï‡Î»ÎµÎ¯Ï„Îµ", tag: 'hobby' }
            ],
            rules: [
                { id: 'rl1', name: "Î’Î¹Î½Ï„ÎµÎ¿ÎºÎ»Î®ÏƒÎ·", price: 20, icon: "ğŸ“¹", desc: "ÎšÎ¬Î¸Îµ Î²ÏÎ¬Î´Ï…", tag: 'comm' },
                { id: 'rl2', name: "ÎšÎ±Î»Î·Î¼Î­ÏÎ± SMS", price: 10, icon: "â˜€ï¸", desc: "Î ÏÏ‰Î¹Î½ÏŒ", tag: 'comm' },
                { id: 'rl3', name: "Î¦ÏÏ„Î¿ Î¤ÏÏÎ±", price: 15, icon: "ğŸ“¸", desc: "ÎŒÏ€Î¿Ï„Îµ Î¶Î·Ï„Î·Î¸ÎµÎ¯", tag: 'content' },
                { id: 'rl4', name: "ÎŒÏ‡Î¹ Î¼ÎµÎ¸ÏÏƒÎ¹", price: 50, icon: "ğŸº", desc: "ÎšÏÏÎ¹Î¿Ï‚", tag: 'behavior' },
                { id: 'rl5', name: "Î‘Ï€Î±Î½Ï„Î¬Ï‰ Î¬Î¼ÎµÏƒÎ±", price: 30, icon: "ğŸ’¬", desc: "Î£Ï„Î± Î¼Î·Î½ÏÎ¼Î±Ï„Î±", tag: 'comm' }
            ]
        };

        const tagLabels = {
            'all': 'ÎŒÎ»Î±', 'clothes': 'Î¡Î¿ÏÏ‡Î±', 'food': 'Î¦Î±Î³Î·Ï„ÏŒ', 'beauty': 'ÎŸÎ¼Î¿ÏÏ†Î¹Î¬',
            'leave': 'Î†Î´ÎµÎ¹ÎµÏ‚', 'hobby': 'Hobby', 'comm': 'Î•Ï€Î¹ÎºÎ¿Î¹Î½Ï‰Î½Î¯Î±', 'content': 'Content', 'behavior': 'Î£Ï…Î¼Ï€ÎµÏÎ¹Ï†Î¿ÏÎ¬'
        };

        window.onload = function() {
            setTimeout(() => {
                document.getElementById('loader').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('loader').style.display = 'none';
                    document.getElementById('welcome-modal').style.display = 'flex';
                }, 500);
            }, 2500); 
            renderHome();
        };

        function closeWelcome() {
            document.getElementById('welcome-modal').style.display = 'none';
            document.getElementById('coupon-hint-modal').style.display = 'flex';
        }

        function openCouponModal() {
            closeModal('coupon-hint-modal');
            document.getElementById('coupon-modal').style.display = 'flex';
        }

        function closeCouponHint() {
            document.getElementById('coupon-hint-modal').style.display = 'none';
        }

        function checkCoupon() {
            if(document.getElementById('coupon-input').value.toUpperCase() === COUPON_CODE) {
                currentBalance = 50; updateCartUI();
                document.getElementById('coupon-modal').style.display = 'none';
                alert("ğŸ‰ Î•Ï€Î¹Ï„Ï…Ï‡Î¯Î±! ÎˆÎ»Î±Î²ÎµÏ‚ 50 Ï€ÏŒÎ½Ï„Î¿Ï…Ï‚."); 
                document.getElementById('balance-display').innerText = currentBalance;
            } else { alert("âŒ Î›Î¬Î¸Î¿Ï‚ ÎºÏ‰Î´Î¹ÎºÏŒÏ‚! (MAK...)"); }
        }

        function applyFilters() {
            const tagSelect = document.getElementById('filter-tag');
            const rangeInput = document.getElementById('filter-price');
            if(tagSelect) currentFilters.tag = tagSelect.value;
            if(rangeInput) currentFilters.maxPrice = rangeInput.value;
            if(document.getElementById('price-val')) document.getElementById('price-val').innerText = currentFilters.maxPrice;

            const category = currentCategory;
            const container = document.getElementById('grid-container');
            const items = db[category].filter(item => {
                if(currentFilters.tag !== 'all' && item.tag !== currentFilters.tag) return false;
                const absPrice = Math.abs(item.price);
                if(absPrice > currentFilters.maxPrice) return false;
                return true;
            });

            let html = '';
            if(items.length === 0) html = '<div style="grid-column:1/-1; text-align:center; color:#999;">Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Î±Ï€Î¿Ï„ÎµÎ»Î­ÏƒÎ¼Î±Ï„Î±.</div>';
            else items.forEach(item => { html += renderCard(item, category); });
            container.innerHTML = html;
        }

        function getFilterHTML(category) {
            const tags = ['all', ...new Set(db[category].map(i => i.tag))];
            let options = tags.map(t => `<option value="${t}">${tagLabels[t] || t}</option>`).join('');
            return `
                <div class="filter-bar">
                    <div class="filter-group"><label class="filter-label">ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±</label><select id="filter-tag" class="filter-select" onchange="applyFilters()">${options}</select></div>
                    <div class="filter-group"><label class="filter-label">Î•ÏÏÎ¿Ï‚ Î ÏŒÎ½Ï„Ï‰Î½ (Max: <span id="price-val">100</span>)</label><input type="range" id="filter-price" class="filter-range" min="0" max="100" value="100" oninput="applyFilters()"></div>
                </div>
                <div id="grid-container" class="grid"></div>
            `;
        }

        function checkStockLimit(id) {
            if(id.startsWith('rl')) return !cart.find(i => i.id === id);
            if(id.startsWith('r1')) return cart.filter(i => i.id.startsWith('r1')).reduce((sum, i) => sum + i.qty, 0) < 1;
            if(id.startsWith('r2')) return cart.filter(i => i.id.startsWith('r2')).reduce((sum, i) => sum + i.qty, 0) < 2;
            return true; 
        }

        function renderHome() {
            currentCategory = 'home';
            document.getElementById('main-content').innerHTML = `
                <div class="hero">
                    <h1>ğŸ…ğŸ» ÎšÎ±Î»ÏÏ‚ Î®ÏÎ¸ÎµÏ‚, ÎœÏ€ÏŒÎ¼Ï€Î¿!</h1>
                    <p>Î¤Î¿ Î§ÏÎ¹ÏƒÏ„Î¿Ï…Î³ÎµÎ½Î½Î¹Î¬Ï„Î¹ÎºÎ¿ ÎºÎ±Ï„Î¬ÏƒÏ„Î·Î¼Î± ÎµÎ¯Î½Î±Î¹ Î±Î½Î¿Î¹Ï‡Ï„ÏŒ ÎºÎ±Î¹ ÏƒÎµ Ï€ÎµÏÎ¹Î¼Î­Î½ÎµÎ¹!</p>
                    <p style="font-size:1.2rem; margin-top:10px;">Î”Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿ Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿: <strong>${currentBalance} pts</strong></p>
                    <button class="btn btn-buy" style="width:200px; background:white; color:var(--primary); margin-top:20px;" onclick="filterCategory('gifts', 'Î”ÏÏÎ±')">ÎÎµÎºÎ¯Î½Î± Ï„Î± Î¨ÏÎ½Î¹Î±</button>
                </div>
                <h3 style="margin-left:10px;">ğŸ”¥ Î”Î·Î¼Î¿Ï†Î¹Î»ÎµÎ¯Ï‚ Î•Ï€Î¹Î»Î¿Î³Î­Ï‚</h3>
                <div class="grid">
                    ${renderCard(db.requests[0], 'requests')}
                    ${renderCard(db.gifts[0], 'gifts')}
                    ${renderCard(db.rules[0], 'rules')}
                </div>
            `;
        }

        function filterCategory(cat, title) {
            currentCategory = cat;
            const container = document.getElementById('main-content');
            if(cat === 'home') return renderHome();
            if(cat === 'extra') return renderExtra(container);
            container.innerHTML = `<h2>${title}</h2>` + getFilterHTML(cat);
            applyFilters();
        }

        function refreshCurrentView() {
            if(currentCategory === 'home') renderHome();
            else if(currentCategory === 'extra') {}
            else applyFilters(); 
        }

        function renderCard(item, type) {
            const isEarn = type === 'rules';
            const priceClass = isEarn ? 'price-pos' : 'price-neg';
            const priceDisplay = item.hasOptions ? `Î±Ï€ÏŒ ${item.price}` : (isEarn ? `+${item.price}` : `${item.price}`);
            
            let isSoldOut = false;
            if(!item.hasOptions && !checkStockLimit(item.id)) isSoldOut = true;
            if(item.id === 'r1' && !checkStockLimit('r1_check')) isSoldOut = true;
            if(item.id === 'r2' && !checkStockLimit('r2_check')) isSoldOut = true;
        
            const btnClass = isSoldOut ? 'btn sold-out' : (isEarn ? 'btn-earn' : 'btn-buy');
            const btnText = isSoldOut ? 'Î•Î¾Î±Î½Ï„Î»Î®Î¸Î·ÎºÎµ' : (isEarn ? 'Î£Ï…Î¼Ï†Ï‰Î½Ï (+)' : 'Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ·');
            
            // Î ÏÎ¿ÏƒÎ¸Î­ÏƒÎ±Î¼Îµ Ï„Î¿ "animateBtn(this);" Ï€ÏÎ¹Î½ Ï„Î¿ addToCart
            let handler = (!isSoldOut) ? (item.hasOptions ? `openOptions('${type}', '${item.id}')` : `animateBtn(this); addToCart('${item.id}', '${item.name}', ${item.price})`) : "";
        
            return `
                <div class="card">
                    <div class="card-content-wrapper">
                        <div class="card-icon">${item.icon}</div>
                        <div class="card-title">${item.name}</div>
                        <div class="card-desc">${item.desc}</div>
                        <div class="price-tag ${priceClass}">${priceDisplay} pts</div>
                    </div>
                    <button class="btn ${btnClass}" onclick="${handler}">${btnText}</button>
                </div>
            `;
        }

        let tempCustomItem = null;
        function renderExtra(container) {
            container.innerHTML = `
                <div class="extra-container">
                    <h2><i class="fas fa-magic"></i> Custom Î‘Î¯Ï„Î·Î¼Î±</h2>
                    <p>Î›Î­Î¾ÎµÎ¹Ï‚ ÏŒÏ€Ï‰Ï‚ "Ï€Î±ÏÎ±ÎºÎ±Î»Ï" ÎºÎ±Î¹ "Î±Î³Î¬Ï€Î·" Î¼ÎµÎ¹ÏÎ½Î¿Ï…Î½ Ï„Î¿ ÎºÏŒÏƒÏ„Î¿Ï‚!</p>
                    <textarea id="custom-text" placeholder="Î“ÏÎ¬ÏˆÎµ ÎµÎ´Ï..."></textarea>
                    <div id="custom-price-preview" style="font-size:1.2rem; margin:15px 0; display:none;"></div>
                    <div class="custom-actions">
                        <button id="calc-btn" class="btn btn-buy" onclick="calculateCustomCost()">Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚</button>
                        <button id="recalc-btn" class="btn btn-buy" style="display:none; background:var(--dark);" onclick="calculateCustomCost()"><i class="fas fa-sync-alt"></i></button>
                        <button id="add-custom-btn" class="btn btn-earn" style="display:none;" onclick="confirmAddCustom()"><i class="fas fa-shopping-cart"></i> Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ·</button>
                    </div>
                </div>`;
        }
        function calculateCustomCost() {
            const txt = document.getElementById('custom-text').value;
            if(!txt) return alert("Î“ÏÎ¬ÏˆÎµ ÎºÎ¬Ï„Î¹!");
            let cost = -40;
            const l = txt.toLowerCase();
            if(l.includes('Ï€Î±ÏÎ±ÎºÎ±Î»Ï') || l.includes('please')) cost += 15;
            if(l.includes('Î±Î³Î¬Ï€Î·') || l.includes('love')) cost += 15;
            if(cost > -5) cost = -5;
            tempCustomItem = { price: cost, text: txt, shortName: 'Custom: ' + txt.substring(0,10) + '...' };
            const prev = document.getElementById('custom-price-preview');
            prev.style.display = 'block'; prev.innerHTML = `ÎšÏŒÏƒÏ„Î¿Ï‚: <span style="color:${cost>0?'green':'red'}">${cost} pts</span>`;
            document.getElementById('calc-btn').style.display = 'none'; document.getElementById('recalc-btn').style.display = 'inline-block'; document.getElementById('add-custom-btn').style.display = 'inline-block';
        }
        function confirmAddCustom() { addToCart('cust_'+Date.now(), tempCustomItem.shortName, tempCustomItem.price, tempCustomItem.text); renderExtra(document.getElementById('main-content')); }
        
        function animateBtn(btn) {
            // ÎšÏÎ±Ï„Î¬Î¼Îµ Ï„Î¿ Î±ÏÏ‡Î¹ÎºÏŒ ÎºÎµÎ¯Î¼ÎµÎ½Î¿ (Ï€.Ï‡. "Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ·")
            const originalText = btn.innerText;
            
            // Î ÏÎ¿ÏƒÎ¸Î­Ï„Î¿Ï…Î¼Îµ Ï„Î·Î½ ÎºÎ»Î¬ÏƒÎ· Ï„Î¿Ï… ÎµÏ†Î­
            btn.classList.add('btn-added');
            
            // Î‘Î»Î»Î¬Î¶Î¿Ï…Î¼Îµ Ï„Î¿ ÎºÎµÎ¯Î¼ÎµÎ½Î¿ Î³Î¹Î± ÎµÏ€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ·
            btn.innerText = "âœ“ Î ÏÎ¿ÏƒÏ„Î­Î¸Î·ÎºÎµ";
            
            // ÎœÎµÏ„Î¬ Î±Ï€ÏŒ 1 Î´ÎµÏ…Ï„ÎµÏÏŒÎ»ÎµÏ€Ï„Î¿, Ï„Î¿ ÎµÏ€Î±Î½Î±Ï†Î­ÏÎ¿Ï…Î¼Îµ
            setTimeout(() => {
                btn.classList.remove('btn-added');
                btn.innerText = originalText;
            }, 1000);
        }
        
        function addToCart(id, name, price, fullText = null) {
            if(!checkStockLimit(id)) return;
            const existing = cart.find(i => i.id === id);
            if(existing) existing.qty++; else cart.push({id, name, price, qty: 1, fullText});
            updateCartUI(); setTimeout(refreshCurrentView, 1000);
            const badge = document.querySelector('.cart-badge'); badge.style.transform = "scale(1.5)"; setTimeout(() => badge.style.transform = "scale(1)", 200);
        }
        function removeFromCart(id) {
            const idx = cart.findIndex(i => i.id === id);
            if(idx > -1) { if(cart[idx].qty > 1) cart[idx].qty--; else cart.splice(idx, 1); }
            updateCartUI(); refreshCurrentView();
        }
        function updateCartUI() {
            let base = (document.getElementById('coupon-input').value.toUpperCase() === COUPON_CODE) ? 50 : 0;
            let cartSum = 0; let count = 0;
            const list = document.getElementById('cart-list-items'); list.innerHTML = '';
            cart.forEach(item => {
                cartSum += (item.price * item.qty); count += item.qty;
                list.innerHTML += `<li class="cart-item"><div><strong>${item.qty}x ${item.name}</strong><br><small>${item.price*item.qty} pts</small></div><i class="fas fa-trash" style="color:#aaa; cursor:pointer;" onclick="removeFromCart('${item.id}')"></i></li>`;
            });
            currentBalance = base + cartSum;
            document.getElementById('balance-display').innerText = currentBalance; document.getElementById('cart-total-display').innerText = currentBalance + ' pts'; document.getElementById('cart-count').innerText = count;
            document.getElementById('cart-total-display').style.color = currentBalance < 0 ? 'var(--primary)' : 'var(--secondary)';
        }

        // --- UI TOGGLES ---
        function openProfile() { document.getElementById('profile-balance').innerText = currentBalance + ' pts'; closeAllSidebars(); document.getElementById('profile-modal').style.display = 'flex'; }
        function toggleNav() { document.getElementById('nav-sidebar').classList.toggle('open'); document.getElementById('backdrop').classList.toggle('active'); document.getElementById('cart-sidebar').classList.remove('open'); }
        function toggleCart() { document.getElementById('cart-sidebar').classList.toggle('open'); document.getElementById('backdrop').classList.toggle('active'); document.getElementById('nav-sidebar').classList.remove('open'); }
        function closeAllSidebars() { document.getElementById('nav-sidebar').classList.remove('open'); document.getElementById('cart-sidebar').classList.remove('open'); document.getElementById('backdrop').classList.remove('active'); }
        function toggleSubMenu(id) { document.getElementById(id).classList.toggle('open'); }
        function openOptions(type, itemId) {
            const item = db[type].find(i => i.id === itemId);
            const container = document.getElementById('opt-buttons'); container.innerHTML = '';
            document.getElementById('opt-title').innerText = item.name;
            item.options.forEach(opt => {
                const isAvail = checkStockLimit(opt.id);
                container.innerHTML += `<div class="opt-btn ${!isAvail?'disabled':''}" onclick="${isAvail?`addToCart('${opt.id}','${opt.name}',${opt.price});closeModal('options-modal')`:''}"><span>${opt.name}</span><b>${isAvail?opt.price+' pts':'Î•ÎÎ‘ÎÎ¤Î›Î—Î˜Î—ÎšÎ•'}</b></div>`;
            });
            document.getElementById('options-modal').style.display = 'flex';
        }
        function openPayment() { if(currentBalance < 0) return alert("âš ï¸ Î¤Î¿ Ï…Ï€ÏŒÎ»Î¿Î¹Ï€Î¿ ÎµÎ¯Î½Î±Î¹ Î±ÏÎ½Î·Ï„Î¹ÎºÏŒ!"); closeAllSidebars(); document.getElementById('payment-modal').style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        // --- PAYMENT & TELEGRAM & OVERVIEW ---
        function processPayment(e) {
            e.preventDefault();
            if(document.getElementById('secret-pin').value !== SECRET_CODE) return alert("âŒ Î›Î¬Î¸Î¿Ï‚ PIN!");
            
            closeModal('payment-modal');
            const overlay = document.getElementById('processing-overlay');
            overlay.style.display = 'flex';

            sendTelegramMessage();

            setTimeout(() => {
                overlay.style.display = 'none';
                generateReceipt();
            }, 3000); 
        }

        function sendTelegramMessage() {
            if(!TG_BOT_TOKEN || !TG_CHAT_ID || TG_BOT_TOKEN.includes("Î’Î‘Î›Î•")) return;
            let msg = "ğŸ›ï¸ *ÎŸ ÎœÏ€ÏŒÎ¼Ï€Î¿Ï‚ Î¿Î»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎµ Ï„Î¹Ï‚ Î±Î³Î¿ÏÎ­Ï‚!*\n\n";
            const expenses = cart.filter(i => i.price < 0);
            if(expenses.length > 0) {
                msg += "ğŸ”» *Î‘Î“ÎŸÎ¡Î•Î£:*\n";
                expenses.forEach(i => { msg += `- ${i.qty}x ${i.name} (${i.price * i.qty} pts)\n`; if(i.fullText) msg += `  _Note: ${i.fullText}_\n`; });
                msg += "\n";
            }
            const income = cart.filter(i => i.price > 0);
            if(income.length > 0) {
                msg += "âœ… *Î¥Î ÎŸÎ§Î¡Î•Î©Î£Î•Î™Î£:*\n";
                income.forEach(i => { msg += `- ${i.qty}x ${i.name} (+${i.price * i.qty} pts)\n`; });
                msg += "\n";
            }
            msg += `ğŸ’° *Î¤Î•Î›Î™ÎšÎŸ Î¥Î ÎŸÎ›ÎŸÎ™Î ÎŸ:* ${currentBalance} pts`;
            const url = `https://api.telegram.org/bot${TG_BOT_TOKEN}/sendMessage?chat_id=${TG_CHAT_ID}&text=${encodeURIComponent(msg)}&parse_mode=Markdown`;
            fetch(url, { mode: 'no-cors' }).catch(err => console.error("Telegram fail:", err));
        }

        function generateReceipt() {
            const container = document.getElementById('receipt-content');
            let html = '<div style="font-size:0.9rem;">';
            const exp = cart.filter(i => i.price < 0);
            if(exp.length) {
                html += '<strong>-- Î‘Î“ÎŸÎ¡Î•Î£ --</strong><br>';
                exp.forEach(i => {
                    if(i.fullText) html += `<details class="receipt-details"><summary><span>${i.qty}x ${i.name}</span><span>${i.price*i.qty}</span></summary><div class="receipt-full-text">"${i.fullText}"</div></details>`;
                    else html += `<div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>${i.qty}x ${i.name}</span><span>${i.price*i.qty}</span></div>`;
                });
            }
            html += '<br><strong>-- Î¥Î ÎŸÎ§Î¡Î•Î©Î£Î•Î™Î£ --</strong><br>';
            const inc = cart.filter(i => i.price > 0);
            inc.forEach(i => html += `<div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>${i.qty}x ${i.name}</span><span>+${i.price*i.qty}</span></div>`);
            
            html += '<hr style="border-top:1px dashed #333">';
            html += `<div style="display:flex; justify-content:space-between; font-size:1.1rem; font-weight:bold;"><span>Î¤Î•Î›Î™ÎšÎŸ:</span><span>${currentBalance} pts</span></div></div>`;
            container.innerHTML = html;
            document.getElementById('receipt-modal').style.display = 'flex';
        }

        // --- OVERVIEW & FINAL ---
        function openOverview() {
            closeModal('receipt-modal');
            const container = document.getElementById('overview-content');
            
            let html = '';
            
            // 1. Expenses
            const expenses = cart.filter(i => i.price < 0);
            let totalExp = 0;
            if (expenses.length > 0) {
                html += '<div class="overview-header">ğŸ›ï¸ Î‘Î³ÏŒÏÎ±ÏƒÎµÏ‚ Ï„Î± Ï€Î±ÏÎ±ÎºÎ¬Ï„Ï‰:</div><ul class="overview-list">';
                expenses.forEach(i => {
                    totalExp += (i.price * i.qty);
                    html += `<li><span>${i.qty}x ${i.name}</span><span>${i.price*i.qty} pts</span></li>`;
                    if(i.fullText) html += `<li style="border:none; color:#777; font-style:italic; font-size:0.8rem; margin-top:-5px;">"${i.fullText}"</li>`;
                });
                html += `<li style="font-weight:bold; border-top:2px solid #ddd;"><span>Î£ÏÎ½Î¿Î»Î¿ Î‘Î³Î¿ÏÏÎ½:</span><span>${totalExp} pts</span></li></ul>`;
            }

            // 2. Commitments
            const income = cart.filter(i => i.price > 0);
            if (income.length > 0) {
                html += '<div class="overview-header" style="background:#e8f5e9; color:#1b5e20;">ğŸ“œ Î”ÎµÏƒÎ¼ÎµÏÏ„Î·ÎºÎµÏ‚ Î½Î± Ï„Î·ÏÎµÎ¯Ï‚:</div><ul class="overview-list">';
                income.forEach(i => {
                    html += `<li><span>${i.qty}x ${i.name}</span><span style="color:#27ae60;">+${i.price*i.qty} pts</span></li>`;
                });
                html += '</ul>';
            }

            container.innerHTML = html;
            document.getElementById('overview-modal').style.display = 'flex';
        }

        function goToFinal() {
            // ÎœÎµÏ„Î¬Î²Î±ÏƒÎ· ÏƒÏ„Î¿ Ï„ÎµÎ»Î¹ÎºÏŒ Î±ÏÏ‡ÎµÎ¯Î¿
            window.location.href = 'timoria.html';
        }

    </script>
</body>
</html>
