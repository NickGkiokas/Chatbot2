<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Î— ÎœÎµÎ³Î¬Î»Î· Î¤Î¹Î¼Ï‰ÏÎ¯Î± ğŸ“œ</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #1a1a1a;
            --accent-red: #ff3333;
            --text-color: #f0f0f0;
            --flag-green: #009246;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            margin: 0; padding: 0; height: 100vh; overflow: hidden;
            background: var(--bg-color); color: var(--text-color);
            display: flex; flex-direction: column; user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        h1 {
            text-align: center; margin: 15px 0; z-index: 10; font-size: 1.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            position: absolute; width: 100%; top: 0; pointer-events: none;
        }

        /* MODALS */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 200;
            justify-content: center; align-items: center; padding: 20px; box-sizing: border-box;
        }

        .modal-content {
            background: #222; color: white; text-align: center; padding: 25px;
            border-radius: 20px; width: 100%; max-width: 400px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8); border: 1px solid #444;
            max-height: 85vh; overflow-y: auto; position: relative;
        }

        /* TEXT & BUTTONS */
        h2 { color: var(--accent-red); margin-top: 0; font-size: 1.5rem; }
        h3 { color: #aaa; font-size: 1.1rem; margin-bottom: 15px; }
        p { line-height: 1.6; color: #ccc; font-size: 0.95rem; margin-bottom: 20px; }

        .btn {
            background: white; color: black; border: none; padding: 15px 30px;
            font-size: 1rem; font-weight: bold; border-radius: 50px; cursor: pointer;
            width: 100%; margin-top: 10px; transition: transform 0.1s;
            box-shadow: 0 5px 15px rgba(255,255,255,0.1);
        }
        .btn:active { transform: scale(0.95); }
        .btn:disabled { background: #555; color: #888; cursor: wait; transform: none; }
        .btn-red { background: var(--accent-red); color: white; }
        .btn-green { background: var(--flag-green); color: white; }
        
        /* NOSE BUTTON STYLES */
        #noseVideo {
            width: 100%; height: 180px; object-fit: cover; border-radius: 10px;
            border: 2px solid #555; background: #000; margin-bottom: 10px; transform: scaleX(-1);
        }
        .nose-btn {
            width: 120px; height: 120px; border-radius: 50%;
            background: radial-gradient(circle, #ff5555, #990000);
            border: 5px solid white; color: white; font-size: 1rem; font-weight: 900;
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.5);
            margin: 10px auto; display: flex; justify-content: center; align-items: center;
            cursor: pointer; user-select: none; -webkit-touch-callout: none;
            touch-action: manipulation; text-align: center; line-height: 1.2;
        }
        .nose-btn:active { transform: scale(0.9); border-color: #00ff00; background: radial-gradient(circle, #009900, #005500); }

        /* CORNER UI */
        #cornerUI {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: black; z-index: 500; flex-direction: column;
            justify-content: center; align-items: center; color: white;
        }
        #timerDisplay { font-size: 5rem; font-weight: 900; font-family: monospace; color: var(--accent-red); transition: color 0.3s; }
        .keep-awake-btn {
            margin-top: 50px; padding: 20px; border-radius: 50%; width: 100px; height: 100px;
            background: #333; border: 2px solid #555; color: #888; font-size: 0.8rem;
        }

        /* LOADING BAR */
        .progress-container { width: 100%; height: 20px; background: #444; border-radius: 10px; margin-top: 15px; overflow: hidden; border: 1px solid #666; }
        .progress-bar { width: 0%; height: 100%; background: linear-gradient(90deg, #ff9900, #ff0000); transition: width 0.1s linear; }
        
        .info-text { font-style: italic; color: #ddd; margin-bottom: 20px; }
        
        /* INPUTS */
        textarea, input[type="text"] {
            width: 100%; background: #333; color: white; 
            border: 1px solid #555; border-radius: 10px; padding: 10px; 
            font-family: inherit; resize: none; box-sizing: border-box; font-size: 1rem;
        }
        
        /* Audio visualizer for nose */
        #voiceIndicator {
            width: 20px; height: 20px; border-radius: 50%; background: #333; 
            display: inline-block; margin-left: 10px; border: 2px solid #555;
        }

    </style>
</head>
<body>

    <h1>Î— Î¤Î™ÎœÎ©Î¡Î™Î‘ âš–ï¸</h1>

    <div id="infoPreNose" class="modal">
        <div class="modal-content">
            <h3>Î’Î®Î¼Î± 1: Î Î•Î™Î˜Î‘Î¡Î§Î™Î‘</h3>
            <p class="info-text">"Î“Î¹Î± Ï„Î¹Î¼Ï‰ÏÎ¯Î± Î¸Î± Ï€Î±Ï„Î®ÏƒÎµÎ¹Ï‚ Ï„Î¿ ÎºÎ¿Ï…Î¼Ï€Î¯ Î¼Îµ Ï„Î· <strong>ÎœÎ¥Î¤Î—</strong> ÏƒÎ¿Ï… Î³Î¹Î± 15 Î´ÎµÏ…Ï„ÎµÏÏŒÎ»ÎµÏ€Ï„Î± ÎºÎ±Î¹ Î¸Î± Î»ÎµÏ‚ 'Î£Ï…Î³Î³Î½ÏÎ¼Î· Ï€Î¿Ï… Î®Î¼Î¿Ï…Î½ Î¬Ï„Î±ÎºÏ„Î· ÎºÎ±Î¹ Î±Î½Ï…Ï€Î¬ÎºÎ¿Ï…Î·'. Î˜Î± ÎºÏÎ±Ï„Î·Î¸ÎµÎ¯ ÏƒÎµ Î²Î¯Î½Ï„ÎµÎ¿ Î³Î¹Î± Î½Î± Î¸Ï…Î¼Î¬ÏƒÎ±Î¹ Ï„Î¹ Î­ÎºÎ±Î½ÎµÏ‚."</p>
            <p class="info-text" style="color:var(--accent-red);">
                <strong>Î Î¡ÎŸÎ£ÎŸÎ§Î—:</strong><br>
                1. ÎœÎ·Î½ ÏƒÎ·ÎºÏÏƒÎµÎ¹Ï‚ Ï„Î· Î¼ÏÏ„Î· ÏƒÎ¿Ï….<br>
                2. Î¤Î±Ï…Ï„ÏŒÏ‡ÏÎ¿Î½Î± Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± Î»ÎµÏ‚ Î”Î¥ÎÎ‘Î¤Î‘:<br>
                <em>"Î£Ï…Î³Î³Î½ÏÎ¼Î· Ï€Î¿Ï… Î®Î¼Î¿Ï…Î½ Î¬Ï„Î±ÎºÏ„Î· ÎºÎ±Î¹ Î±Î½Ï…Ï€Î¬ÎºÎ¿Ï…Î·"</em><br>
                Î‘Î½ ÏƒÏ„Î±Î¼Î±Ï„Î®ÏƒÎµÎ¹Ï‚ Î½Î± Î¼Î¹Î»Î¬Ï‚, Ï‡Î¬Î½ÎµÎ¹Ï‚!
            </p>
            <button class="btn btn-red" onclick="initNoseStage()">Î•Î¯Î¼Î±Î¹ Î­Ï„Î¿Î¹Î¼Î·</button>
        </div>
    </div>

    <div id="noseModal" class="modal">
        <div class="modal-content">
            <h2>Î”ÎŸÎšÎ™ÎœÎ‘Î£Î™Î‘ ÎœÎ¥Î¤Î—Î£</h2>
            <video id="noseVideo" autoplay playsinline muted></video>
            
            <div style="display:flex; align-items:center; justify-content:center; margin:10px;">
                <div id="noseTimer" style="font-size:2.5rem; font-weight:900; color:var(--accent-red);">15.0</div>
                <div id="voiceIndicator"></div>
            </div>
            
            <div class="nose-btn" id="noseBtn" 
                 onmousedown="startNoseHold()" onmouseup="endNoseHold()" 
                 ontouchstart="startNoseHold(event)" ontouchend="endNoseHold(event)">
                Î Î‘Î¤Î‘ ÎœÎ• Î¤Î— ÎœÎ¥Î¤Î—
            </div>
            <p id="noseMsg" style="font-size:0.8rem; color:#aaa; margin-top:10px;">
                ÎšÏÎ¬Ï„Î± & ÎœÎ¯Î»Î±: "Î£Ï…Î³Î³Î½ÏÎ¼Î· Ï€Î¿Ï… Î®Î¼Î¿Ï…Î½ Î¬Ï„Î±ÎºÏ„Î· ÎºÎ±Î¹ Î±Î½Ï…Ï€Î¬ÎºÎ¿Ï…Î·"
            </p>
        </div>
    </div>

    <div id="infoPreWrite" class="modal">
        <div class="modal-content">
            <h3>Î’Î®Î¼Î± 2</h3>
            <p class="info-text">"Î£Ï…Î½ÎµÏ‡Î¯Î¶Î¿Ï…Î¼Îµ. Î ÏÎ­Ï€ÎµÎ¹ Î½Î± Î³ÏÎ¬ÏˆÎµÎ¹Ï‚ Ï„Î·Î½ Ï€ÏÏŒÏ„Î±ÏƒÎ· <strong>SarÃ² una brava ragazza quest'anno</strong>."</p>
            <button class="btn" onclick="startHandwriting()">Î£Ï…Î½Î­Ï‡ÎµÎ¹Î±</button>
        </div>
    </div>

    <div id="handwritingModal" class="modal">
        <div class="modal-content">
            <h2>Î£Î¤Î‘Î”Î™ÎŸ 2: Î“Î¡Î‘Î¦Î—</h2>
            
            <div id="writeChoice">
                <p>Î”Î¹Î¬Î»ÎµÎ¾Îµ Ï„Î·Î½ Ï€Î¿Î¹Î½Î® ÏƒÎ¿Ï…:</p>
                <button class="btn" onclick="chooseHand()">âœï¸ 5 Ï†Î¿ÏÎ­Ï‚ ÏƒÏ„Î¿ Ï‡Î­ÏÎ¹ (ÏƒÏ„Î¿ Ï‡ÏÎ¹ÏƒÏ„Î¿Ï…Î³ÎµÎ½Î½Î¹Î¬Ï„Î¹ÎºÎ¿ Ï‡Î±ÏÏ„Î¯ Î¼Îµ Ï„Î¿ ÎµÎ¹Î´Î¹ÎºÏŒ ÏƒÎ¿Ï… Î¼Î¿Î»ÏÎ²Î¹)</button>
                <button class="btn" onclick="chooseDigital()">ğŸ“± 10 Ï†Î¿ÏÎ­Ï‚ ÏƒÏ„Î¿ ÎºÎ¹Î½Î·Ï„ÏŒ</button>
            </div>

            <div id="writeHand" style="display:none;">
                <p>Î Î¬ÏÎµ Ï‡ÏÎ¹ÏƒÏ„Î¿Ï…Î³ÎµÎ½Î½Î¹Î¬Ï„Î¹ÎºÎ¿ Ï‡Î±ÏÏ„Î¯ ÎºÎ±Î¹ Î³ÏÎ¬ÏˆÎµ <strong>5 Ï†Î¿ÏÎ­Ï‚</strong>:</p>
                <div style="background:#333; padding:10px; border-radius:10px; margin:10px 0; color:#00ff00; font-family:monospace;">
                    "SarÃ² una brava ragazza quest'anno"
                </div>
                <p>Î‘Î½Î­Î²Î±ÏƒÎµ Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±:</p>
                <input type="file" id="photoInput" accept="image/*" style="color:white;">
                <button class="btn btn-red" id="btnUploadWrite" onclick="compressAndUpload('photoInput', 'ğŸ“¸ Î‘Ï€Î¿Î´ÎµÎ¹ÎºÏ„Î¹ÎºÏŒ: Î“ÏÎ±Ï†Î® (Î§Î­ÏÎ¹)', finishHandwriting)">Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î®</button>
            </div>

            <div id="writeDigital" style="display:none;">
                <p>Î“ÏÎ¬ÏˆÎµ (Ï‡Ï‰ÏÎ¯Ï‚ Î½Î± ÎºÎ»Î­ÏˆÎµÎ¹Ï‚!) <strong>10 Ï†Î¿ÏÎ­Ï‚</strong>:</p>
                <div style="background:#333; padding:5px; border-radius:10px; margin-bottom:10px; color:#00ff00; font-family:monospace; font-size:0.8rem;">
                    SarÃ² una brava ragazza quest'anno
                </div>
                <textarea id="digitalInput" rows="10" placeholder="1. SarÃ²... 2. SarÃ²..." onpaste="handlePaste(event)"></textarea>
                <button class="btn btn-red" onclick="submitDigital()">Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î®</button>
            </div>

            <div id="photoStatus" style="margin-top:10px; color:#aaa; font-size:0.8rem;"></div>
        </div>
    </div>

    <div id="infoPreCorner" class="modal">
        <div class="modal-content">
            <h3>Î’Î®Î¼Î± 3</h3>
            <p class="info-text">"ÎšÎ±Î¹ Ï„ÏÏÎ±... Î­Ï†Ï…Î³ÎµÏ‚ ÏƒÏ„Î· Î³Ï‰Î½Î¯Î±! Î£ÎºÎ­ÏˆÎ¿Ï… Ï„Î¹ Î­ÎºÎ±Î½ÎµÏ‚ ÎºÎ±Î¹ Ï„Î¹ Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± ÎºÎ¬Î½ÎµÎ¹Ï‚ Î±Ï€ÏŒ Î´Ï‰ ÎºÎ±Î¹ Ï€Î­ÏÎ±. ÎœÎ·Î½ Î²Î³ÎµÎ¹Ï‚ ÎºÎ±Î¹ Î¼Î·Î½ Ï€Î±Ï„Î¬Ï‚ Ï„Î¯Ï€Î¿Ï„Î± Î±Î½ Î´Îµ Î»Î®Î¾ÎµÎ¹ Î¿ Ï‡ÏÏŒÎ½Î¿Ï‚."</p>
            <button class="btn btn-red" onclick="startCorner(120)">Î Î¬Ï‰ ÏƒÏ„Î· Î“Ï‰Î½Î¯Î±</button>
        </div>
    </div>

    <div id="cornerUI">
        <div style="font-size:3rem;">ğŸ§±</div>
        <h2 style="color:var(--accent-red); margin:10px;">Î¤Î™ÎœÎ©Î¡Î™Î‘ Î£Î¤Î— Î“Î©ÎÎ™Î‘</h2>
        <div id="timerDisplay">02:00</div>
        <p style="color:#666; font-size:0.9rem; text-align:center; padding:0 20px;">
            ÎœÎ·Î½ ÎºÎ»ÎµÎ¯ÏƒÎµÎ¹Ï‚ Ï„Î·Î½ Î¿Î¸ÏŒÎ½Î·.<br>Î‘Î½ Î²Î³ÎµÎ¹Ï‚ Î±Ï€ÏŒ ÎµÎ´Ï, Ï€ÏÎ¿ÏƒÏ„Î¯Î¸ÎµÏ„Î±Î¹ Ï‡ÏÏŒÎ½Î¿Ï‚ (+10s). Î Î¬Ï„Î± Î¼ÏŒÎ½Î¿ Ï„Î¿ ÎºÎ¿Ï…Î¼Ï€Î¯ ÎºÎ¬Ï„Ï‰ Î±Î½ Ï€Î¬ÎµÎ¹ Î½Î± ÏƒÎ²Î®ÏƒÎµÎ¹ Î· Î¿Î¸ÏŒÎ½Î·
        </p>
        <button class="keep-awake-btn" onclick="pokeCorner()">Touch me</button>
        <button id="endCornerBtn" class="btn btn-green" style="display:none; width: 200px; margin-top: 30px;" onclick="finishCorner()">ÎˆÎ¼Î±Î¸Î± Ï„Î¿ Î¼Î¬Î¸Î·Î¼Î¬ Î¼Î¿Ï…</button>
    </div>

    <div id="apologyModal" class="modal">
        <div class="modal-content">
            <h2>Î¤Î•Î›Î™ÎšÎŸÎ£ Î•Î›Î•Î“Î§ÎŸÎ£</h2>
            <p>Î£Ï„ÎµÎ¯Î»Îµ Ï†Ï‰Î½Î·Ï„Î¹ÎºÏŒ Î½Î± Î´ÎµÎ¯Î¾ÎµÎ¹Ï‚ ÏŒÏ„Î¹ Î­Î¼Î±Î¸ÎµÏ‚ ÎºÎ±Î¹ Î¶Î®Ï„Î± ÎµÏ…Î³ÎµÎ½Î¹ÎºÎ¬ Î½Î± Î²Î³ÎµÎ¹Ï‚ Î±Ï€ÏŒ Ï„Î·Î½ Ï„Î¹Î¼Ï‰ÏÎ¯Î± ÏƒÏ„Î· Î³Ï‰Î½Î¯Î±. Î˜Î± Î±Î¾Î¹Î¿Î»Î¿Î³Î·Î¸ÎµÎ¯ Î±Î½ Î®Ï„Î±Î½ Î±ÏÎºÎµÏ„Î¬ ÎµÎ¹Î»Î¹ÎºÏÎ¹Î½Î­Ï‚.</p>
            <button class="btn" id="apologyRecBtn" onmousedown="startApologyRec()" onmouseup="stopApologyRec()" ontouchstart="startApologyRec()" ontouchend="stopApologyRec()">ğŸ™ï¸ ÎšÏÎ¬Ï„Î± Ï€Î±Ï„Î·Î¼Î­Î½Î¿ ÎºÎ±Î¹ Î¬ÏƒÎµ ÏƒÏ„Î¿ Ï„Î­Î»Î¿Ï‚</button>
            <div id="analysisUI" style="display:none; margin-top:20px;">
                <p style="color:#00ff00; font-family:monospace; font-size:0.8rem;">Î‘Î½Î¬Î»Ï…ÏƒÎ· ÎµÎ¹Î»Î¹ÎºÏÎ¯Î½ÎµÎ¹Î±Ï‚...</p>
                <div class="progress-container"><div class="progress-bar" id="apologyBar"></div></div>
            </div>
        </div>
    </div>

    <div id="extraTimeModal" class="modal">
        <div class="modal-content">
            <div style="font-size:3rem;">ğŸ¤¨</div>
            <h2>Î”Î•Î Î•Î Î•Î™Î£Î•Î£</h2>
            <p>ÎŸ Ï„ÏŒÎ½Î¿Ï‚ Ï„Î·Ï‚ Ï†Ï‰Î½Î®Ï‚ ÏƒÎ¿Ï… Î­Î´ÎµÎ¹Î¾Îµ <strong>ÎµÎ¹ÏÏ‰Î½ÎµÎ¯Î± ÎºÎ±Î¹ Ï…Ï†Î¬ÎºÎ¹</strong>.</p>
            <p>Î˜Î± ÎºÎ¬Ï„ÏƒÎµÎ¹Ï‚ Î¬Î»Î»Î¿ <strong>1 Î»ÎµÏ€Ï„ÏŒ</strong> ÏƒÏ„Î· Î³Ï‰Î½Î¯Î±. Î¦ÏÏŒÎ½Ï„Î¹ÏƒÎµ Î±Ï…Ï„Î® Ï„Î· Ï†Î¿ÏÎ¬ Î½Î± Î±ÎºÎ¿Ï…ÏƒÏ„ÎµÎ¯Ï‚ Ï€Î¹Î¿ Ï„Î±Ï€ÎµÎ¹Î½Î®!</p>
            <button class="btn btn-red" onclick="startExtraCorner()">Î Î¯ÏƒÏ‰ ÏƒÏ„Î· Î“Ï‰Î½Î¯Î±</button>
        </div>
    </div>

    <div id="successModal" class="modal">
        <div class="modal-content">
            <div style="font-size: 3rem;">ğŸ‰</div>
            <h2 style="color:var(--flag-green);">Î•Î¤Î£Î™ ÎœÎ Î¡Î‘Î’ÎŸ!</h2>
            <p>Î¤ÏÏÎ± Î¼Ï€Î¿ÏÎµÎ¯Ï‚ Î½Î± Î±Ï€Î¿Ï‡Ï‰ÏÎ®ÏƒÎµÎ¹Ï‚ ÎºÎ±Î¹ Î½Î± Î¾ÎµÎºÎ¹Î½Î®ÏƒÎµÎ¹Ï‚ Ï„Î· Î½Î­Î± Ï‡ÏÎ¿Î½Î¹Î¬ ÏƒÎ±Î½ ÎºÎ±Î»ÏŒ ÎºÎ¿ÏÎ¯Ï„ÏƒÎ¹!</p>
            <button class="btn btn-green" onclick="finishPunishment()">OK</button>
        </div>
    </div>

    <script>
        // ==========================================
        // âš ï¸ Î£Î¤ÎŸÎ™Î§Î•Î™Î‘ BOT âš ï¸
        // ==========================================
        const BOT_TOKEN = '7932574102:AAFQvlNoBw2AWpRuHO7DWlBnRWyA1DhOGuE'; 
        const CHAT_ID = '7336951445';    
        // ==========================================

        // Start directly with the Nose Info Modal
        document.addEventListener("DOMContentLoaded", function() {
            document.getElementById('infoPreNose').style.display = 'flex';
        });

        // --- HELPER FOR NOTIFICATIONS ---
        function sendTelegramNotification(text) {
            fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ chat_id: CHAT_ID, text: text })
            });
        }

        // --- IMAGE UPLOADER ---
        function compressAndUpload(inputId, caption, successCallback) {
            const input = document.getElementById(inputId);
            const btn = document.querySelector(`#${inputId}`).nextElementSibling;

            if(input.files.length === 0) { alert("Î’Î³Î¬Î»Îµ Ï†ÏÏ„Î¿!"); return; }

            const originalBtnText = btn.innerText;
            btn.innerText = "Î£Ï…Î¼Ï€Î¯ÎµÏƒÎ·..."; btn.disabled = true;

            const file = input.files[0];
            const reader = new FileReader();
            reader.readAsDataURL(file);
            
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 800; 
                    const scaleSize = MAX_WIDTH / img.width;
                    canvas.width = MAX_WIDTH;
                    canvas.height = img.height * scaleSize;

                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                    canvas.toBlob((blob) => {
                        btn.innerText = "Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î®...";
                        
                        const formData = new FormData();
                        formData.append('chat_id', CHAT_ID);
                        formData.append('photo', blob, 'image.jpg');
                        formData.append('caption', caption);

                        fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`, {
                            method: 'POST',
                            body: formData
                        })
                        .then(res => res.json())
                        .then(data => {
                            if(data.ok) {
                                setTimeout(successCallback, 1000);
                            } else {
                                alert("Telegram Error: " + data.description);
                                btn.innerText = originalBtnText; btn.disabled = false;
                            }
                        })
                        .catch(err => {
                            alert("Upload Error");
                            btn.innerText = originalBtnText; btn.disabled = false;
                        });
                    }, 'image/jpeg', 0.7);
                }
            }
        }

        // --- STAGE 4: NOSE CHALLENGE ---
        let noseStream = null;
        let noseRecorder = null;
        let noseChunks = [];
        let noseTimer = 15.0;
        let noseInterval;
        let noseActive = false;
        let audioContext, analyser, microphone, dataArray;
        let silenceCounter = 0;

        function initNoseStage() {
            document.getElementById('infoPreNose').style.display = 'none';
            document.getElementById('noseModal').style.display = 'flex';
            
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: true })
            .then(stream => {
                noseStream = stream;
                document.getElementById('noseVideo').srcObject = stream;
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);
                microphone.connect(analyser);
                analyser.fftSize = 256;
                dataArray = new Uint8Array(analyser.frequencyBinCount);
            })
            .catch(err => alert("Need Camera & Mic!"));
        }

        function startNoseHold(e) {
            if(e && e.type === 'touchstart') e.preventDefault();
            if(noseActive) return;
            
            noseActive = true;
            noseTimer = 15.0;
            silenceCounter = 0;
            
            document.getElementById('noseBtn').style.transform = "scale(0.9)";
            document.getElementById('noseBtn').style.background = "radial-gradient(circle, #009900, #005500)";
            document.getElementById('noseMsg').innerText = "ÎœÎ™Î›Î‘! 'Î£Ï…Î³Î³Î½ÏÎ¼Î· Ï€Î¿Ï… Î®Î¼Î¿Ï…Î½ Î¬Ï„Î±ÎºÏ„Î·...'";

            noseChunks = [];
            noseRecorder = new MediaRecorder(noseStream);
            noseRecorder.addEventListener("dataavailable", e => noseChunks.push(e.data));
            noseRecorder.start();

            if(noseInterval) clearInterval(noseInterval);
            noseInterval = setInterval(() => {
                noseTimer -= 0.1;
                document.getElementById('noseTimer').innerText = noseTimer.toFixed(1);
                
                analyser.getByteFrequencyData(dataArray);
                let sum = 0;
                for(let i=0; i<dataArray.length; i++) sum += dataArray[i];
                let average = sum / dataArray.length;
                
                const ind = document.getElementById('voiceIndicator');
                if(average > 10) ind.style.background = "#00ff00";
                else ind.style.background = "#333";

                if(average < 10) {
                    silenceCounter++;
                    if(silenceCounter > 15) failNose("Î”Î•Î Î‘ÎšÎŸÎ¥Î“Î•Î£Î‘Î™! Î Î¡Î•Î Î•Î™ ÎÎ‘ ÎœÎ™Î›Î‘Î£!");
                } else {
                    silenceCounter = 0;
                }
                
                if(noseTimer <= 0) finishNoseSuccess();
            }, 100);
        }

        function endNoseHold(e) {
            if(e && e.type === 'touchend') e.preventDefault();
            if(!noseActive) return; 
            failNose("Î£Î®ÎºÏ‰ÏƒÎµÏ‚ Ï„Î· Î¼ÏÏ„Î·! ÎšÎ»Î­Î²ÎµÎ¹Ï‚!");
        }

        function failNose(msg) {
            noseActive = false;
            clearInterval(noseInterval);
            if(noseRecorder && noseRecorder.state === "recording") noseRecorder.stop();
            document.getElementById('noseBtn').style.transform = "scale(1)";
            document.getElementById('noseBtn').style.background = "radial-gradient(circle, #ff5555, #990000)";
            document.getElementById('noseMsg').innerText = "Î‘Ï€Î­Ï„Ï…Ï‡ÎµÏ‚!";
            document.getElementById('noseTimer').innerText = "FAIL";
            alert(msg + " ÎÎ±Î½Î¬ Î±Ï€ÏŒ Ï„Î·Î½ Î±ÏÏ‡Î®!");
            noseTimer = 15.0;
            document.getElementById('noseTimer').innerText = "15.0";
        }

        function finishNoseSuccess() {
            noseActive = false;
            clearInterval(noseInterval);
            noseRecorder.stop();
            document.getElementById('noseBtn').style.pointerEvents = "none";
            document.getElementById('noseMsg').innerText = "Î•Î Î™Î¤Î¥Î§Î™Î‘! Î‘Î½Î­Î²Î±ÏƒÎ¼Î±...";
            
            noseRecorder.addEventListener("stop", () => {
                const blob = new Blob(noseChunks, { type: 'video/webm' });
                const formData = new FormData();
                formData.append('chat_id', CHAT_ID);
                formData.append('video', blob);
                formData.append('caption', 'ğŸ‘ƒ Î”Î¿ÎºÎ¹Î¼Î±ÏƒÎ¯Î± ÎœÏÏ„Î·Ï‚ + Î‰Ï‡Î¿Ï‚ (Video)');
                
                fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendVideo`, { method: 'POST', body: formData })
                .then(res => res.json())
                .then(data => {
                    if(noseStream) noseStream.getTracks().forEach(track => track.stop());
                    setTimeout(() => {
                        document.getElementById('noseModal').style.display = 'none';
                        document.getElementById('infoPreWrite').style.display = 'flex';
                    }, 1000);
                })
                .catch(err => alert("Video Upload Error"));
            });
        }

        // --- STAGE 5: HANDWRITING ---
        function startHandwriting() {
            document.getElementById('infoPreWrite').style.display = 'none';
            document.getElementById('handwritingModal').style.display = 'flex';
            // Start with Choice
            document.getElementById('writeChoice').style.display = 'block';
            document.getElementById('writeHand').style.display = 'none';
            document.getElementById('writeDigital').style.display = 'none';
        }

        function chooseHand() {
            document.getElementById('writeChoice').style.display = 'none';
            document.getElementById('writeHand').style.display = 'block';
        }

        function chooseDigital() {
            document.getElementById('writeChoice').style.display = 'none';
            document.getElementById('writeDigital').style.display = 'block';
        }

        function handlePaste(e) {
            e.preventDefault();
            alert("ÎšÎ›Î•Î’Î•Î™Î£! Î‘Ï€Î±Î³Î¿ÏÎµÏÎµÏ„Î±Î¹ Ï„Î¿ copy-paste! ÎœÎ·Î´ÎµÎ½Î¹ÏƒÎ¼ÏŒÏ‚!");
            document.getElementById('digitalInput').value = "";
        }

        function submitDigital() {
            const text = document.getElementById('digitalInput').value;
            // Basic length check (phrase ~30 chars * 10 = 300) - lenient check > 100
            if(text.length < 100) { alert("Î”ÎµÎ½ Ï„Î¿ Î­Î³ÏÎ±ÏˆÎµÏ‚ 10 Ï†Î¿ÏÎ­Ï‚! ÎœÎ·Î½ ÎºÎ»Î­Î²ÎµÎ¹Ï‚!"); return; }
            
            const msg = `ğŸ“ *Î¤Î¹Î¼Ï‰ÏÎ¯Î± Î“ÏÎ±Ï†Î®Ï‚ (ÎšÎ¹Î½Î·Ï„ÏŒ):*\n${text}`;
            fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ chat_id: CHAT_ID, text: msg })
            }).then(() => {
                finishHandwriting();
            });
        }

        function finishHandwriting() {
            document.getElementById('handwritingModal').style.display = 'none';
            document.getElementById('infoPreCorner').style.display = 'flex';
        }

        // --- CORNER ---
        let cornerTime = 0;
        let cornerInterval;
        let servedExtra = false;

        function startCorner(seconds) {
            document.getElementById('infoPreCorner').style.display = 'none';
            document.getElementById('extraTimeModal').style.display = 'none'; 
            document.getElementById('cornerUI').style.display = 'flex';
            cornerTime = seconds; updateTimer();
            document.addEventListener('visibilitychange', handleVisibilityChange);
            document.getElementById('cornerUI').addEventListener('click', handleBadClick);
            cornerInterval = setInterval(() => {
                cornerTime--; updateTimer();
                if(cornerTime <= 0) {
                    clearInterval(cornerInterval);
                    document.getElementById('endCornerBtn').style.display = 'block';
                    document.getElementById('timerDisplay').style.color = '#00ff00';
                }
            }, 1000);
        }

        function updateTimer() {
            const m = Math.floor(cornerTime / 60).toString().padStart(2, '0');
            const s = (cornerTime % 60).toString().padStart(2, '0');
            document.getElementById('timerDisplay').innerText = `${m}:${s}`;
        }

        function handleVisibilityChange() {
            if(document.hidden && document.getElementById('cornerUI').style.display === 'flex') {
                cornerTime += 10;
                const t = document.getElementById('timerDisplay');
                t.style.color = 'red';
                setTimeout(() => t.style.color = 'var(--accent-red)', 1000);
            }
        }

        function handleBadClick(e) {
            if(e.target.id === 'cornerUI') {
                cornerTime += 10;
                const t = document.getElementById('timerDisplay');
                t.style.color = 'red';
                setTimeout(() => t.style.color = 'var(--accent-red)', 200);
            }
        }

        function pokeCorner() { /* Dummy */ }

        function finishCorner() {
            document.removeEventListener('visibilitychange', handleVisibilityChange);
            document.getElementById('cornerUI').removeEventListener('click', handleBadClick);
            clearInterval(cornerInterval);
            sendTelegramNotification("âœ… ÎŸ ÎœÏ€ÏŒÎ¼Ï€Î¿Ï‚ Î­ÎºÎ±Ï„ÏƒÎµ Ï„Î¹Î¼Ï‰ÏÎ¯Î± ÏƒÏ„Î· Î“Ï‰Î½Î¯Î±.");
            document.getElementById('cornerUI').style.display = 'none';
            document.getElementById('apologyModal').style.display = 'flex';
        }

        // --- APOLOGY ---
        let apolRecorder;
        let apolChunks = [];

        async function startApologyRec() {
            try {
                const s = await navigator.mediaDevices.getUserMedia({ audio: true });
                apolRecorder = new MediaRecorder(s);
                apolChunks = [];
                apolRecorder.addEventListener("dataavailable", e => apolChunks.push(e.data));
                apolRecorder.start();
                document.getElementById('apologyRecBtn').style.background = 'red';
            } catch(e) { alert("Mic Error"); }
        }

        function stopApologyRec() {
            if(!apolRecorder) return;
            apolRecorder.stop();
            document.getElementById('apologyRecBtn').style.background = 'white';
            
            apolRecorder.addEventListener("stop", () => {
                const blob = new Blob(apolChunks, { type: 'audio/ogg' });
                document.getElementById('analysisUI').style.display = 'block';
                document.getElementById('apologyBar').style.width = '100%';
                const cap = servedExtra ? "Î¤ÎµÎ»Î¹ÎºÎ® Î£Ï…Î³Î³Î½ÏÎ¼Î· (Î”ÎµÎºÏ„Î®)" : "Î ÏÏÏ„Î· Î£Ï…Î³Î³Î½ÏÎ¼Î· (Î‘Ï€Î¿ÏÏÎ¯Ï†Î¸Î·ÎºÎµ)";
                sendVoice(blob, cap, () => {
                    setTimeout(handleApologyResult, 2000);
                });
            });
        }

        function sendVoice(blob, caption, callback) {
            const formData = new FormData();
            formData.append('chat_id', CHAT_ID);
            formData.append('voice', blob);
            formData.append('caption', caption);
            fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendVoice`, { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => {
                if(data.ok) callback();
                else alert("Telegram Error: " + data.description);
            });
        }

        function handleApologyResult() {
            document.getElementById('apologyModal').style.display = 'none';
            document.getElementById('analysisUI').style.display = 'none';
            document.getElementById('apologyBar').style.width = '0%';
            if(!servedExtra) {
                document.getElementById('extraTimeModal').style.display = 'flex';
                servedExtra = true;
            } else {
                document.getElementById('successModal').style.display = 'flex';
            }
        }

        function startExtraCorner() {
            document.getElementById('endCornerBtn').style.display = 'none';
            document.getElementById('timerDisplay').style.color = 'var(--accent-red)';
            startCorner(60); 
        }

        function finishPunishment() {
            window.location.href = 'index.html?evaluated=true';
        }
    </script>
</body>
</html>
